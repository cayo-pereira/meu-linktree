<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Renderização do Cartão</title>
    {# Incluindo as fontes usadas no seu user_page.html e admin.html #}
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        @page {
            size: 380px 220px; /* Dimensões exatas do cartão para o PDF */
            margin: 0; /* Remove margens da página PDF */
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 380px; /* Largura da área de conteúdo do PDF */
            height: 220px; /* Altura da área de conteúdo do PDF */
            font-family: '{{ dados.card_nome_font | default(DEFAULT_FONT, true) | style_safe }}', sans-serif;
            box-sizing: border-box;
            background-color: transparent; /* O fundo real virá do .card-container */
        }
        .card-container {
            border-radius: 15px;
            color: #fff; 
            padding: 15px 20px;
            width: 380px; 
            height: 220px; 
            text-align: center;
            display: flex; /* Usado para flex-direction column */
            flex-direction: column;
            position: relative; /* Para o pseudo-elemento ::before */
            overflow: hidden; /* Para que o border-radius afete o conteúdo interno e o ::before */
            box-sizing: border-box;
            {% if dados.card_background_type == 'color' %}
                background-color: {{ dados.card_background_value | default('#4361ee', true) }};
            {% elif dados.card_background_type == 'image' and dados.card_background_value %}
                /* URLs de background para WeasyPrint devem ser acessíveis. */
                /* Se for uma URL do Supabase, já é absoluta. */
                /* Se fosse um arquivo estático local, precisaria ser um caminho que WeasyPrint pudesse resolver. */
                background-image: url('{{ dados.card_background_value }}');
                background-size: cover;
                background-position: center;
            {% else %}
                background-color: #4361ee; /* Fallback */
            {% endif %}
        }
        .card-container::before { /* Overlay para legibilidade */
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.25); 
            z-index: 1; /* Fica abaixo do .card-content mas acima do background */
            border-radius: 15px; 
        }
        .card-content {
            position: relative; 
            z-index: 2; /* Acima do overlay */
            width: 100%; 
            height: 100%;
            display: flex; 
            flex-direction: column; 
            justify-content: space-between; /* Para empurrar o bottom-section para baixo */
            align-items: center; 
            padding-top: 5px; /* Ajustes de padding interno */
            padding-bottom: 5px; 
            box-sizing: border-box;
        }
        .card-header-info {
            flex-grow: 1; /* Ocupa espaço vertical disponível no header */
            display: flex; 
            flex-direction: column; 
            justify-content: center; /* Centraliza verticalmente o conteúdo do header */
            align-items: center; 
            text-align: center; 
            width: 100%; 
            margin-bottom: 5px; /* Espaço antes dos links/endereço */
            overflow: hidden; /* Evita que textos longos quebrem o layout */
        }
        .card-name {
            font-family: '{{ dados.card_nome_font | default(DEFAULT_FONT, true) | style_safe }}';
            color: {{ dados.card_nome_color | default(DEFAULT_TEXT_COLOR_CARD, true) }};
            font-size: 20px; 
            margin-bottom: 1px; 
            font-weight: 700; 
            overflow-wrap: break-word; /* CORRIGIDO */
        }
        .card-title { 
            font-family: '{{ dados.card_titulo_font | default(DEFAULT_FONT, true) | style_safe }}';
            color: {{ dados.card_titulo_color | default(DEFAULT_TITLE_COLOR_CARD, true) }};
            font-size: 14px; 
            margin-bottom: 1px; 
            font-weight: 500; 
            overflow-wrap: break-word; /* CORRIGIDO */
        }
        .card-registration { 
            font-family: '{{ dados.card_registro_font | default(DEFAULT_FONT, true) | style_safe }}';
            color: {{ dados.card_registro_color | default(DEFAULT_REG_COLOR_CARD, true) }};
            font-size: 12px; 
            margin-bottom: 0; 
            overflow-wrap: break-word; /* CORRIGIDO */
        }
        
        .card-bottom-section {
            display: flex;
            justify-content: space-between; 
            align-items: flex-end; 
            width: 100%;
            margin-top: auto; /* Empurra para o fundo do card-content */
            gap: 8px; 
            min-height: 40px; /* Altura mínima para acomodar links/endereço */
        }

        .card-links {
            display: flex; 
            flex-direction: column; 
            gap: 2px; 
            align-items: flex-start; 
            flex-grow: 1; /* Ocupa o espaço à esquerda */
            overflow: hidden; /* Para texto com ellipsis funcionar */
        }
        .card-link-item {
            display: flex; 
            align-items: center; 
            gap: 5px; 
            padding: 1px 0; 
            text-decoration: none; 
            width: 100%; /* Para que o ellipsis funcione corretamente no texto */
        }
        .card-icon {
            width: 16px; 
            height: 16px; 
            object-fit: contain; 
            flex-shrink: 0; /* Não encolhe o ícone */
        }
        .card-link-text {
            font-size: 12px; 
            white-space: nowrap;     /* Importante para ellipsis */
            overflow: hidden;        /* Importante para ellipsis */
            text-overflow: ellipsis; /* Adiciona "..." se o texto for muito longo */
            flex-grow: 1;            /* Permite que o texto ocupe o espaço restante */
            min-width: 0;            /* Necessário para flexbox com ellipsis */
            text-align: left;
            /* A cor e a fonte são aplicadas inline via Jinja */
        }

        .card-address-area {
            flex-shrink: 0; /* Não encolhe a área do endereço */
            text-align: right;
            max-width: 45%; /* Limita a largura para não comprimir demais os links */
        }
        .card-address-text {
            font-size: 11px; 
            margin: 0;
            overflow-wrap: break-word; /* CORRIGIDO */
            line-height: 1.25;
            padding-bottom: 2px; /* Alinhamento com a base dos ícones */
            /* A cor e a fonte são aplicadas inline via Jinja */
        }

    </style>
</head>
<body>
    <div class="card-container">
        <div class="card-content">
            <div class="card-header-info">
                <div class="card-name">{{ dados.card_nome if dados.card_nome else dados.nome }}</div>
                {% if dados.card_titulo %}<div class="card-title">{{ dados.card_titulo }}</div>{% endif %}
                {% if dados.card_registro_profissional %}<div class="card-registration">{{ dados.card_registro_profissional }}</div>{% endif %}
            </div>

            <div class="card-bottom-section"> {# Container para links e endereço #}
                <div class="card-links">
                    {% for link in dados.card_links %}
                    <div class="card-link-item">
                        {# CORREÇÃO: Removido _external=True de url_for para que WeasyPrint use o base_url #}
                        <img src="{{ url_for('static', filename='icons/' + link.icon + '.png') }}" class="card-icon" alt="{{ link.icon }}">
                        {% if link.at_text %}
                        <span class="card-link-text" style="font-family: '{{ link.font | default(DEFAULT_FONT, true) | style_safe }}'; color: {{ link.color | default(dados.card_link_text_color, true) | default(DEFAULT_TEXT_COLOR_CARD, true) }};">
                            {{ link.at_text }}
                        </span>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>

                {% if dados.card_endereco %}
                <div class="card-address-area">
                    <p class="card-address-text" style="font-family: '{{ dados.card_endereco_font | default(DEFAULT_FONT, true) | style_safe }}'; color: {{ dados.card_endereco_color | default(DEFAULT_CARD_ENDERECO_COLOR, true) }};">
                        {{ dados.card_endereco }}
                    </p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</body>
</html>