<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='admin.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='dark-mode.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        /* Estilos para o preview de imagem */
        .image-preview-container {
            margin-top: 15px;
            display: none;
        }

        .image-preview {
            width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: var(--border-radius);
            border: 1px dashed var(--primary-color);
            padding: 5px;
            background-color: rgba(67, 97, 238, 0.05);
            margin-top: 10px;
        }

        .preview-active {
            display: block;
        }

        .file-upload-wrapper {
            position: relative;
            margin-bottom: 15px;
        }

        .file-info {
            display: none;
            padding: 8px;
            background-color: var(--input-bg-light);
            border-radius: var(--border-radius);
            margin-top: 5px;
            color: var(--text-color-light);
        }

        .has-file .file-info {
            display: block;
        }

        .has-file .file-label {
            background-color: var(--success-color);
            color: white;
        }

        .btn-delete {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-delete:hover {
            background-color: #d32f2f;
            transform: translateY(-2px);
        }

        .profile-url {
            display: flex;
            align-items: center;
        }

        .url-prefix {
            padding: 0.8rem 1rem; /* Mesmo padding do form-input */
            background: var(--input-bg-light);
            border: 1px solid var(--border-color-light);
            border-right: none;
            border-radius: var(--border-radius) 0 0 var(--border-radius); /* Ajuste no border-radius */
            color: var(--text-color-light);
            font-size: 1rem; /* Mesmo font-size do form-input */
            line-height: 1.6; /* Mesmo line-height do body */
        }
        /* Ajuste para que o input da URL ocupe o espaço restante e alinhe corretamente */
        .profile-url .form-input {
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
        }


        .form-group-inline {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap; 
        }

        .form-group-inline label {
            margin-bottom: 0;
            font-weight: normal;
            white-space: nowrap;
        }

        .form-group-inline input[type="checkbox"] {
            width: auto;
            margin-right: 5px;
        }

        .form-group-inline input[type="color"],
        .form-group input[type="color"] /* Para o novo campo de cor de link do cartão */
         {
            padding: 0; 
            min-width: 35px; 
            height: 35px;
            border: 1px solid var(--border-color-light); 
            border-radius: 4px;
            cursor: pointer;
            background: none; 
        }
        .form-group-inline select.form-input {
            flex-grow: 1; 
            min-width: 120px; 
        }


        .custom-button-item .button-preview {
            border: 1px solid transparent;
            transition: all 0.3s ease;
        }

        .custom-button-item .button-preview.has-border-preview {
            border-style: solid;
        }

        .custom-button-item .button-preview.hover-effect-preview:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .border-options-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .border-options-group .form-group-inline {
            margin-bottom: 0;
        }

        .social-item,
        .custom-button-item,
        .card-link-item { 
            cursor: grab; 
            display: flex; 
            align-items: center;
            gap: 1rem;
            background: var(--input-bg-light);
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
            transition: box-shadow 0.2s ease, transform 0.2s ease;
            border: 1px solid var(--border-color-light); 
        }

        .social-item:hover,
        .custom-button-item:hover,
        .card-link-item:hover { 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .sortable-ghost {
            opacity: 0.4;
            background-color: #e0e0e0;
            border: 1px dashed var(--primary-color);
        }

        .sortable-chosen {
            cursor: grabbing;
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        .drag-handle {
            cursor: grab;
            font-size: 1.2rem;
            color: #888;
            margin-right: 0.5rem;
        }

        #button-preview-area {
            margin: 20px 0;
            padding: 15px;
            background-color: var(--input-bg-light);
            border: 1px dashed var(--border-color-light);
            border-radius: var(--border-radius);
            text-align: center;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #live-button-preview {
            padding: 10px 20px;
            border-radius: 10px;
            background-color: #4CAF50;
            color: white;
            font-size: 16px;
            font-weight: normal;
            font-style: normal;
            text-decoration: none;
            display: inline-block;
            transition: all 0.1s ease-out; 
            white-space: nowrap; 
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 90%; 
        }

        .shadow-none { box-shadow: none; }
        .shadow-soft { box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .shadow-medium { box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); }
        .shadow-hard { box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3); }
        .shadow-inset { box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2); }

        .card-link-item .form-input {
            flex-grow: 1; 
        }
        .card-link-item .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-grow: 1;
        }
        .card-link-item .input-group input {
            flex: 1;
        }
        .card-link-item img {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }

        .card-background-options {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            margin-bottom: 15px;
        }
        .card-background-options label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: normal;
            cursor: pointer;
        }
        .card-background-preview {
            width: 50px;
            height: 50px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color-light);
            display: inline-block;
            vertical-align: middle;
            margin-left: 10px;
        }
        #card_background_image_preview_container {
            margin-top: 10px;
        }
        #card_background_image_preview {
            max-height: 150px;
        }

        /* Estilos para preview de texto */
        .text-preview {
            padding: 10px;
            border: 1px dashed #ccc; /* Cor da borda do preview */
            margin-top: 10px;
            border-radius: var(--border-radius);
            background-color: var(--input-bg-light); /* Adapta ao tema */
            color: var(--text-color-light); /* Adapta ao tema */
            min-height: 40px; /* Altura mínima para visualização */
            transition: all 0.2s ease; /* Transição suave para mudanças */
            white-space: pre-line; /* Para respeitar quebras de linha na bio */
            word-wrap: break-word; /* Garante que palavras longas quebrem */
            font-size: 0.9em; /* Tamanho um pouco menor para preview */
        }
    </style>
</head>

<body>

    <div class="flash-messages">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }}">
            {{ message }}
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}
    </div>

    <form method="POST" action="{{ url_for('delete_page') }}"
        onsubmit="return confirm('Tem certeza que deseja APAGAR SUA PÁGINA permanentemente? Esta ação não pode ser desfeita!')"
        style="position: absolute; top: 20px; left: 20px;">
        <button type="submit" class="btn-delete">
            <i class="fas fa-trash"></i> Apagar Página
        </button>
    </form>

    <div class="admin-container">
        <div class="admin-header">
            <h1><i class="fas fa-cog"></i> Painel Administrativo</h1>
            <p>Edite suas informações pessoais</p>
        </div>

        <form method="POST" enctype="multipart/form-data" action="{{ url_for('admin_panel', username=dados.profile) }}"
            class="admin-form">
            <div class="form-grid">
                <div class="form-section">
                    <h2><i class="fas fa-user"></i> Informações Pessoais</h2>

                    <div class="form-group">
                        <label for="nome">Nome Completo</label>
                        <input type="text" id="nome" name="nome" value="{{ dados.nome }}" class="form-input" oninput="updateTextPreview('nome_preview', this.value, getValue('nome_font'), getValue('nome_color'))">
                        <div class="form-group-inline" style="margin-top: 8px;">
                            <label for="nome_font">Fonte:</label>
                            <select id="nome_font" name="nome_font" class="form-input" onchange="updateTextPreview('nome_preview', getValue('nome'), this.value, getValue('nome_color'))">
                                <option value="Inter, sans-serif" {% if dados.nome_font == 'Inter, sans-serif' %}selected{% endif %}>Padrão (Inter)</option>
                                <option value="Arial, sans-serif" {% if dados.nome_font == 'Arial, sans-serif' %}selected{% endif %}>Arial</option>
                                <option value="Verdana, sans-serif" {% if dados.nome_font == 'Verdana, sans-serif' %}selected{% endif %}>Verdana</option>
                                <option value="Georgia, serif" {% if dados.nome_font == 'Georgia, serif' %}selected{% endif %}>Georgia</option>
                                <option value="'Times New Roman', Times, serif" {% if dados.nome_font == "'Times New Roman', Times, serif" %}selected{% endif %}>Times New Roman</option>
                                <option value="'Courier New', Courier, monospace" {% if dados.nome_font == "'Courier New', Courier, monospace" %}selected{% endif %}>Courier New</option>
                                <option value="Roboto, sans-serif" {% if dados.nome_font == 'Roboto, sans-serif' %}selected{% endif %}>Roboto</option>
                                <option value="'Open Sans', sans-serif" {% if dados.nome_font == "'Open Sans', sans-serif" %}selected{% endif %}>Open Sans</option>
                                <option value="Lato, sans-serif" {% if dados.nome_font == 'Lato, sans-serif' %}selected{% endif %}>Lato</option>
                                <option value="Montserrat, sans-serif" {% if dados.nome_font == 'Montserrat, sans-serif' %}selected{% endif %}>Montserrat</option>
                            </select>
                            <label for="nome_color">Cor:</label>
                            <input type="color" id="nome_color" name="nome_color" value="{{ dados.nome_color | default('#333333', true) }}" oninput="updateTextPreview('nome_preview', getValue('nome'), getValue('nome_font'), this.value)">
                        </div>
                        <div class="text-preview" id="nome_preview">Prévia do Nome</div>
                    </div>

                    <div class="form-group">
                        <label for="bio">Biografia</label>
                        <textarea id="bio" name="bio" class="form-textarea" oninput="updateTextPreview('bio_preview', this.value, getValue('bio_font'), getValue('bio_color'))">{{ dados.bio }}</textarea>
                        <div class="form-group-inline" style="margin-top: 8px;">
                            <label for="bio_font">Fonte:</label>
                            <select id="bio_font" name="bio_font" class="form-input" onchange="updateTextPreview('bio_preview', getValue('bio'), this.value, getValue('bio_color'))">
                                <option value="Inter, sans-serif" {% if dados.bio_font == 'Inter, sans-serif' %}selected{% endif %}>Padrão (Inter)</option>
                                <option value="Arial, sans-serif" {% if dados.bio_font == 'Arial, sans-serif' %}selected{% endif %}>Arial</option>
                                <option value="Verdana, sans-serif" {% if dados.bio_font == 'Verdana, sans-serif' %}selected{% endif %}>Verdana</option>
                                <option value="Georgia, serif" {% if dados.bio_font == 'Georgia, serif' %}selected{% endif %}>Georgia</option>
                                <option value="'Times New Roman', Times, serif" {% if dados.bio_font == "'Times New Roman', Times, serif" %}selected{% endif %}>Times New Roman</option>
                                <option value="'Courier New', Courier, monospace" {% if dados.bio_font == "'Courier New', Courier, monospace" %}selected{% endif %}>Courier New</option>
                                <option value="Roboto, sans-serif" {% if dados.bio_font == 'Roboto, sans-serif' %}selected{% endif %}>Roboto</option>
                                <option value="'Open Sans', sans-serif" {% if dados.bio_font == "'Open Sans', sans-serif" %}selected{% endif %}>Open Sans</option>
                                <option value="Lato, sans-serif" {% if dados.bio_font == 'Lato, sans-serif' %}selected{% endif %}>Lato</option>
                                <option value="Montserrat, sans-serif" {% if dados.bio_font == 'Montserrat, sans-serif' %}selected{% endif %}>Montserrat</option>
                            </select>
                            <label for="bio_color">Cor:</label>
                            <input type="color" id="bio_color" name="bio_color" value="{{ dados.bio_color | default('#555555', true) }}" oninput="updateTextPreview('bio_preview', getValue('bio'), getValue('bio_font'), this.value)">
                        </div>
                        <div class="text-preview" id="bio_preview">Prévia da Biografia</div>
                    </div>

                    <div class="form-group">
                        <label for="profile">URL da sua página</label>
                        <div class="profile-url">
                            <span class="url-prefix">cpages.onrender.com/</span> <input type="text" id="profile" name="profile" value="{{ dados.profile }}" class="form-input"
                                pattern="[a-z0-9-]+" title="Apenas letras minúsculas, números e hífens">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h2><i class="fas fa-images"></i> Imagens da Página</h2>

                    <div class="form-group">
                        <label for="foto_upload">Foto de Perfil</label>
                        <div class="file-upload-wrapper">
                            <div class="file-upload">
                                <input type="file" id="foto_upload" name="foto_upload" accept="image/*" class="file-input"
                                    onchange="previewImage(this, 'foto_preview', 'foto_info')">
                                <label for="foto_upload" class="file-label">
                                    <i class="fas fa-cloud-upload-alt"></i> Escolher arquivo
                                </label>
                            </div>
                            <div class="file-info" id="foto_info">Nenhum arquivo selecionado</div>
                            <div class="image-preview-container" id="foto_preview_container">
                                <img src="{{ dados.foto if dados.foto else '' }}" class="image-preview" id="foto_preview"
                                    onerror="this.style.display='none'">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="background_upload">Imagem de Fundo da Página</label>
                        <div class="file-upload-wrapper">
                            <div class="file-upload">
                                <input type="file" id="background_upload" name="background_upload" accept="image/*" class="file-input"
                                    onchange="previewImage(this, 'background_preview', 'background_info')">
                                <label for="background_upload" class="file-label">
                                    <i class="fas fa-cloud-upload-alt"></i> Escolher arquivo
                                </label>
                            </div>
                            <div class="file-info" id="background_info">Nenhum arquivo selecionado</div>
                            <div class="image-preview-container" id="background_preview_container">
                                <img src="{{ dados.background if dados.background else '' }}" class="image-preview"
                                    id="background_preview" onerror="this.style.display='none'">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h2><i class="fas fa-link"></i> Links Sociais e Botões</h2>

                    <div class="buttons-container">
                        <button type="button" class="btn btn-add" id="add-icon-btn">
                            <i class="fas fa-plus"></i> Adicionar Ícone Social
                        </button>
                        <button type="button" class="btn btn-add" id="add-button-btn">
                            <i class="fas fa-plus"></i> Adicionar Botão Personalizado
                        </button>
                    </div>

                    <div id="social-icons-container">
                        {% if dados.social_links %}
                            {% for link in dados.social_links %}
                            <div class="social-item">
                                <i class="fas fa-grip-vertical drag-handle"></i> <img src="/static/icons/{{ link.icon }}.png" alt="{{ link.icon }}" width="24">
                                <input type="hidden" name="social_icon_name[]" value="{{ link.icon }}">
                                <input type="text" name="social_icon_url[]"
                                            value="{{ link.url }}"
                                            placeholder="Insira o link para {{ link.icon.replace('-', ' ') }}"
                                            class="form-input" required>
                                <span class="remove-item"><i class="fas fa-times"></i></span>
                            </div>
                            {% endfor %}
                        {% endif %}
                    </div>

                    <div id="custom-buttons-container">
                        {% if dados.custom_buttons %}
                            {% for button in dados.custom_buttons %}
                            <div class="custom-button-item">
                                <i class="fas fa-grip-vertical drag-handle"></i> <div style="flex-grow: 1;">
                                    <div class="button-preview {% if button.hasBorder %}has-border-preview{% endif %} {% if button.hasHoverEffect %}hover-effect-preview{% endif %} {% if button.shadowType %}shadow-{{ button.shadowType }}{% endif %}"
                                        style="background: {{ button.color }}; border-radius: {{ button.radius }}px; padding: 8px; margin-bottom: 8px; color: {{ button.textColor }}; font-weight: {{ 'bold' if button.bold else 'normal' }}; font-style: {{ 'italic' if button.italic else 'normal' }}; font-size: {{ button.fontSize }}px; {% if button.hasBorder %}border: {{ button.borderWidth }}px solid {{ button.borderColor }};{% endif %}">
                                        {{ button.text }}
                                    </div>
                                    <input type="hidden" name="custom_button_text[]" value="{{ button.text }}">
                                    <input type="hidden" name="custom_button_link[]" value="{{ button.link }}">
                                    <input type="hidden" name="custom_button_color[]" value="{{ button.color }}">
                                    <input type="hidden" name="custom_button_radius[]" value="{{ button.radius }}">
                                    <input type="hidden" name="custom_button_text_color[]" value="{{ button.textColor }}">
                                    <input type="hidden" name="custom_button_text_bold[]" value="{{ 'true' if button.bold else 'false' }}">
                                    <input type="hidden" name="custom_button_text_italic[]" value="{{ 'true' if button.italic else 'false' }}">
                                    <input type="hidden" name="custom_button_font_size[]" value="{{ button.fontSize }}">
                                    <input type="hidden" name="custom_button_has_border[]" value="{{ 'true' if button.hasBorder else 'false' }}">
                                    <input type="hidden" name="custom_button_border_color[]" value="{{ button.borderColor }}">
                                    <input type="hidden" name="custom_button_border_width[]" value="{{ button.borderWidth }}">
                                    <input type="hidden" name="custom_button_has_hover[]" value="{{ 'true' if button.hasHoverEffect else 'false' }}">
                                    <input type="hidden" name="custom_button_shadow_type[]" value="{{ button.shadowType | default('none') }}">
                                </div>
                                <span class="remove-item"><i class="fas fa-times"></i></span>
                            </div>
                            {% endfor %}
                        {% endif %}
                    </div>

                    <div id="icon-modal" class="modal">
                        <div class="modal-content">
                            <span class="close icon-modal-close">&times;</span>
                            <h3>Selecione um ícone</h3>
                            <div class="form-group">
                                <input type="text" id="icon-search" class="form-input" placeholder="Buscar ícones...">
                            </div>
                            <div class="pagination-container">
                                <button type="button" class="pagination-btn" id="prev-icon-page"><i class="fas fa-chevron-left"></i></button>
                                <div class="icons-grid"></div>
                                <button type="button" class="pagination-btn" id="next-icon-page"><i class="fas fa-chevron-right"></i></button>
                            </div>
                            <div class="page-info" style="text-align: center; margin-top: 10px; font-size: 0.9rem;">Página <span id="current-page">1</span></div>
                            <button type="button" id="save-icon" class="btn-save">Salvar Ícone</button>
                        </div>
                    </div>

                    <div id="button-modal" class="modal">
                        <div class="modal-content">
                            <span class="close button-modal-close">&times;</span>
                            <h3>Criar Novo Botão</h3>
                            <div id="button-preview-area">
                                <a href="#" id="live-button-preview">Texto do Botão</a>
                            </div>
                            <div class="form-group"><label for="button-text">Texto do Botão</label><input type="text" id="button-text" class="form-input" placeholder="Ex: Currículo"></div>
                            <div class="form-group"><label for="button-link">Link</label><input type="text" id="button-link" class="form-input" placeholder="https://"></div>
                            <div class="form-group"><label for="button-color">Cor do Botão</label><input type="color" id="button-color" value="#4CAF50"></div>
                            <div class="form-group"><label for="button-radius">Arredondamento (px)</label><input type="range" id="button-radius" min="0" max="20" value="10"><span id="radius-value">10px</span></div>
                            <div class="form-group"><label for="button-text-color">Cor do Texto</label><input type="color" id="button-text-color" value="#FFFFFF"></div>
                            <div class="form-group-inline"><label>Estilo do Texto:</label><input type="checkbox" id="button-text-bold" name="button-text-bold"><label for="button-text-bold">Negrito</label><input type="checkbox" id="button-text-italic" name="button-text-italic"><label for="button-text-italic">Itálico</label></div>
                            <div class="form-group"><label for="button-font-size">Tamanho da Fonte (px)</label><input type="number" id="button-font-size" min="12" max="30" value="16" class="form-input"></div>
                            <div class="form-group-inline"><input type="checkbox" id="button-has-border"><label for="button-has-border">Adicionar Borda</label><div id="border-options-group" style="display: none;" class="border-options-group"><div class="form-group-inline"><label for="button-border-color">Cor</label><input type="color" id="button-border-color" value="#000000"></div><div class="form-group-inline"><label for="button-border-width">Tamanho (px)</label><input type="number" id="button-border-width" min="1" max="10" value="2" class="form-input" style="width: 60px;"></div></div></div>
                            <div class="form-group-inline"><input type="checkbox" id="button-has-hover"><label for="button-has-hover">Efeito Hover</label></div>
                            <div class="form-group"><label for="button-shadow-type">Tipo de Sombra</label><select id="button-shadow-type" class="form-input"><option value="none">Nenhuma</option><option value="soft">Suave</option><option value="medium">Média</option><option value="hard">Forte</option><option value="inset">Interna (Inset)</option></select></div>
                            <button type="button" id="save-button" class="btn-save">Salvar Botão</button>
                        </div>
                    </div>
                </div>

                <div class="form-section card-section-full-width"> 
                    <h2><i class="fas fa-id-card"></i> Cartão de Visitas</h2>
                    
                    <div class="form-group">
                        <label for="card_nome">Nome Completo (Cartão)</label>
                        <input type="text" id="card_nome" name="card_nome" value="{{ dados.card_nome }}" class="form-input" oninput="updateTextPreview('card_nome_preview', this.value, getValue('card_nome_font'), getValue('card_nome_color'))">
                        <div class="form-group-inline" style="margin-top: 8px;">
                            <label for="card_nome_font">Fonte:</label>
                            <select id="card_nome_font" name="card_nome_font" class="form-input" onchange="updateTextPreview('card_nome_preview', getValue('card_nome'), this.value, getValue('card_nome_color'))">
                                <option value="Inter, sans-serif" {% if dados.card_nome_font == 'Inter, sans-serif' %}selected{% endif %}>Padrão (Inter)</option>
                                <option value="Arial, sans-serif" {% if dados.card_nome_font == 'Arial, sans-serif' %}selected{% endif %}>Arial</option>
                                <option value="Verdana, sans-serif" {% if dados.card_nome_font == 'Verdana, sans-serif' %}selected{% endif %}>Verdana</option>
                                <option value="Georgia, serif" {% if dados.card_nome_font == 'Georgia, serif' %}selected{% endif %}>Georgia</option>
                                <option value="'Times New Roman', Times, serif" {% if dados.card_nome_font == "'Times New Roman', Times, serif" %}selected{% endif %}>Times New Roman</option>
                                <option value="'Courier New', Courier, monospace" {% if dados.card_nome_font == "'Courier New', Courier, monospace" %}selected{% endif %}>Courier New</option>
                                <option value="Roboto, sans-serif" {% if dados.card_nome_font == 'Roboto, sans-serif' %}selected{% endif %}>Roboto</option>
                                <option value="'Open Sans', sans-serif" {% if dados.card_nome_font == "'Open Sans', sans-serif" %}selected{% endif %}>Open Sans</option>
                                <option value="Lato, sans-serif" {% if dados.card_nome_font == 'Lato, sans-serif' %}selected{% endif %}>Lato</option>
                                <option value="Montserrat, sans-serif" {% if dados.card_nome_font == 'Montserrat, sans-serif' %}selected{% endif %}>Montserrat</option>
                            </select>
                            <label for="card_nome_color">Cor:</label>
                            <input type="color" id="card_nome_color" name="card_nome_color" value="{{ dados.card_nome_color | default('#FFFFFF', true) }}" oninput="updateTextPreview('card_nome_preview', getValue('card_nome'), getValue('card_nome_font'), this.value)">
                        </div>
                        <div class="text-preview" id="card_nome_preview">Prévia do Nome (Cartão)</div>
                    </div>

                    <div class="form-group">
                        <label for="card_titulo">Título/Profissão</label>
                        <input type="text" id="card_titulo" name="card_titulo" value="{{ dados.card_titulo }}" class="form-input" oninput="updateTextPreview('card_titulo_preview', this.value, getValue('card_titulo_font'), getValue('card_titulo_color'))">
                        <div class="form-group-inline" style="margin-top: 8px;">
                            <label for="card_titulo_font">Fonte:</label>
                            <select id="card_titulo_font" name="card_titulo_font" class="form-input" onchange="updateTextPreview('card_titulo_preview', getValue('card_titulo'), this.value, getValue('card_titulo_color'))">
                               <option value="Inter, sans-serif" {% if dados.card_titulo_font == 'Inter, sans-serif' %}selected{% endif %}>Padrão (Inter)</option>
                                <option value="Arial, sans-serif" {% if dados.card_titulo_font == 'Arial, sans-serif' %}selected{% endif %}>Arial</option>
                                <option value="Verdana, sans-serif" {% if dados.card_titulo_font == 'Verdana, sans-serif' %}selected{% endif %}>Verdana</option>
                                <option value="Georgia, serif" {% if dados.card_titulo_font == 'Georgia, serif' %}selected{% endif %}>Georgia</option>
                                <option value="'Times New Roman', Times, serif" {% if dados.card_titulo_font == "'Times New Roman', Times, serif" %}selected{% endif %}>Times New Roman</option>
                                <option value="'Courier New', Courier, monospace" {% if dados.card_titulo_font == "'Courier New', Courier, monospace" %}selected{% endif %}>Courier New</option>
                                <option value="Roboto, sans-serif" {% if dados.card_titulo_font == 'Roboto, sans-serif' %}selected{% endif %}>Roboto</option>
                                <option value="'Open Sans', sans-serif" {% if dados.card_titulo_font == "'Open Sans', sans-serif" %}selected{% endif %}>Open Sans</option>
                                <option value="Lato, sans-serif" {% if dados.card_titulo_font == 'Lato, sans-serif' %}selected{% endif %}>Lato</option>
                                <option value="Montserrat, sans-serif" {% if dados.card_titulo_font == 'Montserrat, sans-serif' %}selected{% endif %}>Montserrat</option>
                            </select>
                            <label for="card_titulo_color">Cor:</label>
                            <input type="color" id="card_titulo_color" name="card_titulo_color" value="{{ dados.card_titulo_color | default('#EEEEEE', true) }}" oninput="updateTextPreview('card_titulo_preview', getValue('card_titulo'), getValue('card_titulo_font'), this.value)">
                        </div>
                         <div class="text-preview" id="card_titulo_preview">Prévia do Título</div>
                    </div>

                    <div class="form-group">
                        <label for="card_registro_profissional">Registro Profissional (Ex: CREA, OAB)</label>
                        <input type="text" id="card_registro_profissional" name="card_registro_profissional" value="{{ dados.card_registro_profissional }}" class="form-input" oninput="updateTextPreview('card_registro_preview', this.value, getValue('card_registro_font'), getValue('card_registro_color'))">
                        <div class="form-group-inline" style="margin-top: 8px;">
                            <label for="card_registro_font">Fonte:</label>
                            <select id="card_registro_font" name="card_registro_font" class="form-input" onchange="updateTextPreview('card_registro_preview', getValue('card_registro_profissional'), this.value, getValue('card_registro_color'))">
                                <option value="Inter, sans-serif" {% if dados.card_registro_font == 'Inter, sans-serif' %}selected{% endif %}>Padrão (Inter)</option>
                                <option value="Arial, sans-serif" {% if dados.card_registro_font == 'Arial, sans-serif' %}selected{% endif %}>Arial</option>
                                <option value="Verdana, sans-serif" {% if dados.card_registro_font == 'Verdana, sans-serif' %}selected{% endif %}>Verdana</option>
                                <option value="Georgia, serif" {% if dados.card_registro_font == 'Georgia, serif' %}selected{% endif %}>Georgia</option>
                                <option value="'Times New Roman', Times, serif" {% if dados.card_registro_font == "'Times New Roman', Times, serif" %}selected{% endif %}>Times New Roman</option>
                                <option value="'Courier New', Courier, monospace" {% if dados.card_registro_font == "'Courier New', Courier, monospace" %}selected{% endif %}>Courier New</option>
                                <option value="Roboto, sans-serif" {% if dados.card_registro_font == 'Roboto, sans-serif' %}selected{% endif %}>Roboto</option>
                                <option value="'Open Sans', sans-serif" {% if dados.card_registro_font == "'Open Sans', sans-serif" %}selected{% endif %}>Open Sans</option>
                                <option value="Lato, sans-serif" {% if dados.card_registro_font == 'Lato, sans-serif' %}selected{% endif %}>Lato</option>
                                <option value="Montserrat, sans-serif" {% if dados.card_registro_font == 'Montserrat, sans-serif' %}selected{% endif %}>Montserrat</option>
                            </select>
                            <label for="card_registro_color">Cor:</label>
                            <input type="color" id="card_registro_color" name="card_registro_color" value="{{ dados.card_registro_color | default('#BBBBBB', true) }}" oninput="updateTextPreview('card_registro_preview', getValue('card_registro_profissional'), getValue('card_registro_font'), this.value)">
                        </div>
                        <div class="text-preview" id="card_registro_preview">Prévia do Registro</div>
                    </div>


                    <div class="form-group">
                        <label>Background do Cartão:</label>
                        <div class="card-background-options">
                            <label>
                                <input type="radio" name="card_background_type" value="color" {% if dados.card_background_type == 'color' or dados.card_background_type is none %}checked{% endif %}>
                                Cor Sólida
                                <input type="color" id="card_background_color_picker" name="card_background_value_color" value="{{ dados.card_background_value if dados.card_background_type == 'color' else '#4361ee' }}" class="form-input" style="width: 50px; height: 30px; padding:0; border: none;">
                            </label>
                            <label>
                                <input type="radio" name="card_background_type" value="image" {% if dados.card_background_type == 'image' %}checked{% endif %}>
                                Imagem
                            </label>
                        </div>
                        <div id="card_background_image_upload_section" style="display: {% if dados.card_background_type == 'image' %}block{% else %}none{% endif %};">
                            <div class="file-upload-wrapper">
                                <div class="file-upload">
                                    <input type="file" id="card_background_upload" name="card_background_upload" accept="image/*" class="file-input"
                                        onchange="previewImage(this, 'card_background_image_preview', 'card_background_info');">
                                    <label for="card_background_upload" class="file-label">
                                        <i class="fas fa-cloud-upload-alt"></i> Escolher imagem para o cartão
                                    </label>
                                </div>
                                <div class="file-info" id="card_background_info">
                                    {% if dados.card_background_type == 'image' and dados.card_background_value %}
                                        {% else %}
                                        Nenhum arquivo selecionado
                                    {% endif %}
                                </div>
                                <div class="image-preview-container" id="card_background_image_preview_container" style="display: {% if dados.card_background_type == 'image' and dados.card_background_value %}block{% else %}none{% endif %};">
                                    <img src="{{ dados.card_background_value if dados.card_background_type == 'image' else '' }}" class="image-preview" id="card_background_image_preview"
                                        onerror="this.style.display='none'">
                                    {% if dados.card_background_type == 'image' and dados.card_background_value %}
                                    <button type="button" class="btn-delete btn-sm" id="remove_card_background_image_btn" style="margin-top: 10px; display: inline-flex; align-items: center; gap: 5px;"><i class="fas fa-times-circle"></i>Remover Imagem</button>
                                    {% else %}
                                    <button type="button" class="btn-delete btn-sm" id="remove_card_background_image_btn" style="margin-top: 10px; display: none; align-items: center; gap: 5px;"><i class="fas fa-times-circle"></i>Remover Imagem</button>
                                    {% endif %}
                                    <input type="hidden" name="remove_card_background_image" id="remove_card_background_image" value="false">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="card_link_text_color">Cor do Texto dos Links do Cartão</label>
                        <input type="color" id="card_link_text_color" name="card_link_text_color" value="{{ dados.card_link_text_color | default(DEFAULT_CARD_LINK_TEXT_COLOR, true) }}">
                    </div>
                    <div class="form-group">
                        <label>Links Customizáveis do Cartão (até 3)</label>
                        <button type="button" class="btn btn-add" id="add-card-link-btn">
                            <i class="fas fa-plus"></i> Adicionar Link ao Cartão
                        </button>
                        <div id="card-links-container">
                            {% if dados.card_links %}
                                {% for link in dados.card_links %}
                                <div class="card-link-item">
                                    <i class="fas fa-grip-vertical drag-handle"></i> <img src="/static/icons/{{ link.icon }}.png" alt="{{ link.icon }}" width="24">
                                    <input type="hidden" name="card_icon_name[]" value="{{ link.icon }}">
                                    <div class="input-group">
                                        <input type="text" name="card_icon_url[]"
                                                    value="{{ link.url }}"
                                                    placeholder="URL (Opcional)"
                                                    class="form-input">
                                        <input type="text" name="card_icon_at_text[]"
                                                    value="{{ link.at_text }}"
                                                    placeholder="@texto"
                                                    class="form-input">
                                    </div>
                                    <span class="remove-item"><i class="fas fa-times"></i></span>
                                </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>

            </div>

            <div class="form-actions">
                <button type="submit" class="btn-save">
                    <i class="fas fa-save"></i> Salvar Alterações
                </button>
                <a href="{{ url_for('logout') }}" class="btn-logout">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </a>
            </div>
        </form>
    </div>
    <script>
        // Função para obter valor de um elemento
        function getValue(elementId) {
            const el = document.getElementById(elementId);
            return el ? el.value : '';
        }

        // Função para atualizar preview de texto
        function updateTextPreview(previewElementId, text, font, color) {
            const previewEl = document.getElementById(previewElementId);
            if (previewEl) {
                previewEl.textContent = text || 'Prévia...'; 
                previewEl.style.fontFamily = font || 'Inter, sans-serif'; 
                
                if (previewElementId.includes('card_')) { 
                    previewEl.style.backgroundColor = '#444'; 
                    previewEl.style.color = color || '#FFFFFF'; 
                } else { 
                    previewEl.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--input-bg-light').trim();
                    previewEl.style.color = color || getComputedStyle(document.documentElement).getPropertyValue('--text-color-light').trim();
                }
            }
        }

        function previewImage(input, previewId, fileInfoId) {
            const previewContainer = document.getElementById(previewId + '_container');
            const previewImageEl = document.getElementById(previewId);
            const fileInfoEl = document.getElementById(fileInfoId); 
            const fileWrapper = input.closest('.file-upload-wrapper');
            const removeBtn = document.getElementById('remove_card_background_image_btn'); 

            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    previewImageEl.src = e.target.result;
                    previewImageEl.style.display = 'block';
                    if (previewContainer) previewContainer.style.display = 'block'; 
                    if (previewContainer) previewContainer.classList.add('preview-active');
                    if (fileInfoEl) fileInfoEl.textContent = input.files[0].name;
                    if (fileWrapper) fileWrapper.classList.add('has-file');
                    if (previewId === 'card_background_image_preview' && removeBtn) {
                        removeBtn.style.display = 'inline-flex'; 
                        document.getElementById('remove_card_background_image').value = 'false'; 
                    }
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        

        document.addEventListener('DOMContentLoaded', function () {
            updateTextPreview('nome_preview', getValue('nome'), getValue('nome_font'), getValue('nome_color'));
            updateTextPreview('bio_preview', getValue('bio'), getValue('bio_font'), getValue('bio_color'));
            updateTextPreview('card_nome_preview', getValue('card_nome'), getValue('card_nome_font'), getValue('card_nome_color'));
            updateTextPreview('card_titulo_preview', getValue('card_titulo'), getValue('card_titulo_font'), getValue('card_titulo_color'));
            updateTextPreview('card_registro_preview', getValue('card_registro_profissional'), getValue('card_registro_font'), getValue('card_registro_color'));

            const fotosParaPreview = [
                { id: 'foto_preview', infoId: 'foto_info', uploadId: 'foto_upload' },
                { id: 'background_preview', infoId: 'background_info', uploadId: 'background_upload' },
                { id: 'card_background_image_preview', infoId: 'card_background_info', uploadId: 'card_background_upload' }
            ];

            fotosParaPreview.forEach(item => {
                const previewElement = document.getElementById(item.id);
                const infoElement = document.getElementById(item.infoId);
                const containerElement = document.getElementById(item.id + '_container');
                const uploadInput = document.getElementById(item.uploadId);
                const fileWrapper = uploadInput ? uploadInput.closest('.file-upload-wrapper') : null;

                if (previewElement && previewElement.src && previewElement.src !== window.location.href && !previewElement.src.includes('blob:') && previewElement.src.trim() !== '') {
                    if(containerElement) containerElement.style.display = 'block'; 
                    if(containerElement) containerElement.classList.add('preview-active');
                    if (infoElement) {
                         try {
                            const urlParts = previewElement.src.split('/');
                            const fileNameWithQuery = urlParts[urlParts.length - 1];
                            const fileName = fileNameWithQuery.split('?')[0]; 
                            infoElement.textContent = `Atual: ${decodeURIComponent(fileName)}`;
                        } catch (e) {
                            infoElement.textContent = 'Imagem atual';
                        }
                    }
                    if (fileWrapper) fileWrapper.classList.add('has-file');
                    if (item.id === 'card_background_image_preview') {
                        const removeBtn = document.getElementById('remove_card_background_image_btn');
                        if (removeBtn) removeBtn.style.display = 'inline-flex';
                    }
                } else {
                    if (infoElement) infoElement.textContent = 'Nenhum arquivo selecionado';
                    if (containerElement) containerElement.style.display = 'none'; 
                    if (item.id === 'card_background_image_preview') {
                        const removeBtn = document.getElementById('remove_card_background_image_btn');
                        if (removeBtn) removeBtn.style.display = 'none';
                    }
                }
            });

            const removeCardBgBtn = document.getElementById('remove_card_background_image_btn');
            const cardBgUploadInput = document.getElementById('card_background_upload');
            const cardBgImagePreview = document.getElementById('card_background_image_preview');
            const cardBgImagePreviewContainer = document.getElementById('card_background_image_preview_container');
            const removeCardBgHiddenInput = document.getElementById('remove_card_background_image');
            const cardBgInfo = document.getElementById('card_background_info');
            
            if (removeCardBgBtn) {
                removeCardBgBtn.addEventListener('click', () => {
                    if(cardBgUploadInput) cardBgUploadInput.value = ''; 
                    if(cardBgImagePreview) cardBgImagePreview.src = '';
                    if(cardBgImagePreview) cardBgImagePreview.style.display = 'none';
                    if(cardBgImagePreviewContainer) cardBgImagePreviewContainer.classList.remove('preview-active');
                    if(cardBgImagePreviewContainer) cardBgImagePreviewContainer.style.display = 'none'; 
                    if(cardBgInfo) cardBgInfo.textContent = 'Nenhum arquivo selecionado';
                    const cardBgUploadWrapper = cardBgUploadInput ? cardBgUploadInput.closest('.file-upload-wrapper') : null;
                    if(cardBgUploadWrapper) cardBgUploadWrapper.classList.remove('has-file');
                    if(removeCardBgHiddenInput) removeCardBgHiddenInput.value = 'true'; 
                    removeCardBgBtn.style.display = 'none'; 
                });
            }


            function escapeHtml(text) {
                if (typeof text !== 'string') {
                    return ''; 
                }
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return text.replace(/[&<>"']/g, function (m) { return map[m]; });
            }

            function renderCustomButton(buttonData) {
                const customButtonsContainer = document.getElementById('custom-buttons-container');
                
                const buttonField = document.createElement('div');
                buttonField.className = 'custom-button-item';

                const textColor = buttonData.textColor || '#FFFFFF';
                const bold = buttonData.bold || false;
                const italic = buttonData.italic || false;
                const fontSize = buttonData.fontSize || 16;
                const hasBorder = buttonData.hasBorder || false;
                const borderColor = buttonData.borderColor || '#000000';
                const borderWidth = buttonData.borderWidth || 2;
                const hasHoverEffect = buttonData.hasHoverEffect || false;
                const shadowType = buttonData.shadowType || 'none';

                let borderStyle = '';
                let buttonPreviewClasses = ['button-preview'];
                if (hasBorder) {
                    borderStyle = `border: ${borderWidth}px solid ${borderColor};`;
                    buttonPreviewClasses.push('has-border-preview');
                }
                if (hasHoverEffect) {
                    buttonPreviewClasses.push('hover-effect-preview');
                }
                if (shadowType && shadowType !== 'none') { 
                    buttonPreviewClasses.push(`shadow-${shadowType}`);
                }

                buttonField.innerHTML = `
                    <i class="fas fa-grip-vertical drag-handle"></i> <div style="flex-grow: 1;">
                        <div class="${buttonPreviewClasses.join(' ')}" 
                            style="background: ${buttonData.color}; border-radius: ${buttonData.radius}px; padding: 8px; margin-bottom: 8px; color: ${textColor}; font-weight: ${bold ? 'bold' : 'normal'}; font-style: ${italic ? 'italic' : 'normal'}; font-size: ${fontSize}px; ${borderStyle}">
                            ${escapeHtml(buttonData.text)}
                        </div>
                        <input type="hidden" name="custom_button_text[]" value="${escapeHtml(buttonData.text)}">
                        <input type="hidden" name="custom_button_link[]" value="${escapeHtml(buttonData.link)}">
                        <input type="hidden" name="custom_button_color[]" value="${escapeHtml(buttonData.color)}">
                        <input type="hidden" name="custom_button_radius[]" value="${escapeHtml(String(buttonData.radius))}">
                        <input type="hidden" name="custom_button_text_color[]" value="${escapeHtml(textColor)}">
                        <input type="hidden" name="custom_button_text_bold[]" value="${bold}">
                        <input type="hidden" name="custom_button_text_italic[]" value="${italic}">
                        <input type="hidden" name="custom_button_font_size[]" value="${fontSize}">
                        <input type="hidden" name="custom_button_has_border[]" value="${hasBorder}">
                        <input type="hidden" name="custom_button_border_color[]" value="${escapeHtml(borderColor)}">
                        <input type="hidden" name="custom_button_border_width[]" value="${escapeHtml(String(borderWidth))}">
                        <input type="hidden" name="custom_button_has_hover[]" value="${hasHoverEffect}">
                        <input type="hidden" name="custom_button_shadow_type[]" value="${escapeHtml(shadowType)}">
                    </div>
                    <span class="remove-item"><i class="fas fa-times"></i></span>
                `;
                if (customButtonsContainer) customButtonsContainer.appendChild(buttonField);

                buttonField.querySelector('.remove-item').addEventListener('click', function () {
                    this.closest('.custom-button-item').remove();
                });
            }

            function renderExistingSocialIcons(socialLinks) {
                const socialIconsContainer = document.getElementById('social-icons-container');
                if (!socialIconsContainer) return;
                socialIconsContainer.innerHTML = '';

                socialLinks.forEach(link => {
                    const newIconField = document.createElement('div');
                    newIconField.className = 'social-item';
                    const iconPath = `/static/icons/${link.icon}.png`;

                    newIconField.innerHTML = `
                        <i class="fas fa-grip-vertical drag-handle"></i> <img src="${iconPath}" alt="${link.icon}" width="24">
                        <input type="hidden" name="social_icon_name[]" value="${escapeHtml(link.icon)}">
                        <input type="text" name="social_icon_url[]"
                                    value="${escapeHtml(link.url)}"
                                    placeholder="Insira o link para ${link.icon.replace(/-/g, ' ')}"
                                    class="form-input" required>
                        <span class="remove-item"><i class="fas fa-times"></i></span>
                    `;
                    socialIconsContainer.appendChild(newIconField);

                    newIconField.querySelector('.remove-item').addEventListener('click', function () {
                        this.closest('.social-item').remove();
                    });
                });
            }

            function renderExistingCardLinks(cardLinks) {
                const cardLinksContainer = document.getElementById('card-links-container');
                if (!cardLinksContainer) return;
                cardLinksContainer.innerHTML = '';

                cardLinks.forEach(link => {
                    const newLinkField = document.createElement('div');
                    newLinkField.className = 'card-link-item';
                    const iconPath = `/static/icons/${link.icon}.png`;

                    newLinkField.innerHTML = `
                        <i class="fas fa-grip-vertical drag-handle"></i> <img src="${iconPath}" alt="${link.icon}" width="24">
                        <input type="hidden" name="card_icon_name[]" value="${escapeHtml(link.icon)}">
                        <div class="input-group">
                            <input type="text" name="card_icon_url[]"
                                        value="${escapeHtml(link.url)}"
                                        placeholder="URL (Opcional)"
                                        class="form-input">
                            <input type="text" name="card_icon_at_text[]"
                                        value="${escapeHtml(link.at_text)}"
                                        placeholder="@texto"
                                        class="form-input">
                        </div>
                        <span class="remove-item"><i class="fas fa-times"></i></span>
                    `;
                    cardLinksContainer.appendChild(newLinkField);

                    newLinkField.querySelector('.remove-item').addEventListener('click', function () {
                        this.closest('.card-link-item').remove();
                    });
                });
            }
            
            /*
            try {
                const socialLinks = {{ dados.social_links | tojson | safe }};
                if (Array.isArray(socialLinks)) { 
                    renderExistingSocialIcons(socialLinks);
                }
            } catch (e) {
                console.error('Erro ao carregar ícones sociais:', e);
            }

            try {
                const cardLinks = {{ dados.card_links | tojson | safe }};
                 if (Array.isArray(cardLinks)) { 
                    renderExistingCardLinks(cardLinks);
                }
            } catch (e) {
                console.error('Erro ao carregar links do cartão:', e);
            }
            
            try {
                const customButtons = {{ dados.custom_buttons | tojson | safe }};
                if (Array.isArray(customButtons)) { 
                    customButtons.forEach(button => renderCustomButton(button));
                }
            } catch (e) {
                console.error('Erro ao carregar botões personalizados:', e);
            }
            */


            document.querySelector('#icon-modal .modal-content').addEventListener('click', (e) => {
                e.stopPropagation();
            });
            document.querySelector('#button-modal .modal-content').addEventListener('click', (e) => {
                e.stopPropagation();
            });

            const socialIconsContainer = document.getElementById('social-icons-container');
            const customButtonsContainer = document.getElementById('custom-buttons-container');
            const cardLinksContainer = document.getElementById('card-links-container'); 

            if (socialIconsContainer) new Sortable(socialIconsContainer, { animation: 150, ghostClass: 'sortable-ghost', chosenClass: 'sortable-chosen', handle: '.drag-handle', });
            if (customButtonsContainer) new Sortable(customButtonsContainer, { animation: 150, ghostClass: 'sortable-ghost', chosenClass: 'sortable-chosen', handle: '.drag-handle', });
            if (cardLinksContainer) new Sortable(cardLinksContainer, { animation: 150, ghostClass: 'sortable-ghost', chosenClass: 'sortable-chosen', handle: '.drag-handle', });
            
            const iconModal = document.getElementById('icon-modal');
            const buttonModal = document.getElementById('button-modal');
            const addIconBtn = document.getElementById('add-icon-btn');
            const addButtonBtn = document.getElementById('add-button-btn');
            const addCardLinkBtn = document.getElementById('add-card-link-btn'); 

            const iconModalCloseBtn = document.querySelector('.icon-modal-close');
            const buttonModalCloseBtn = document.querySelector('.button-modal-close');

            const iconsGrid = document.querySelector('#icon-modal .icons-grid');
            const iconSearchInput = document.getElementById('icon-search');
            const prevIconPageBtn = document.getElementById('prev-icon-page');
            const nextIconPageBtn = document.getElementById('next-icon-page');
            const currentPageSpan = document.getElementById('current-page');

            let currentModalPurpose = ''; 

            const allSocialIcons = [ { name: 'instagram', path: '/static/icons/instagram.png' }, { name: 'linkedin', path: '/static/icons/linkedin.png' }, { name: 'github', path: '/static/icons/github.png' }, { name: 'email', path: '/static/icons/email.png' }, { name: 'whatsapp', path: '/static/icons/whatsapp.png' }, { name: 'twitter', path: '/static/icons/twitter.png' }, { name: 'facebook', path: '/static/icons/facebook.png' }, { name: 'youtube', path: '/static/icons/youtube.png' }, { name: 'telegram', path: '/static/icons/telegram.png' }, { name: 'tiktok', path: '/static/icons/tiktok.png' }, { name: 'pinterest', path: '/static/icons/pinterest.png' }, { name: 'twitch', path: '/static/icons/twitch.png' }, { name: 'discord', path: '/static/icons/discord.png' }, { name: 'snapchat', path: '/static/icons/snapchat.png' }, { name: 'reddit', path: '/static/icons/reddit.png' }, { name: 'vimeo', path: '/static/icons/vimeo.png' }, { name: 'medium', path: '/static/icons/medium.png' }, { name: 'spotify', path: '/static/icons/spotify.png' }, { name: 'soundcloud', path: '/static/icons/soundcloud.png' }, { name: 'behance', path: '/static/icons/behance.png' }, { name: 'dribbble', path: '/static/icons/dribbble.png' }, { name: 'flickr', path: '/static/icons/flickr.png' }, { name: 'etsy', path: '/static/icons/etsy.png' }, { name: 'paypal', path: '/static/icons/paypal.png' }, { name: 'google-drive', path: '/static/icons/google-drive.png' }, { name: 'dropbox', path: '/static/icons/dropbox.png' }, { name: 'link', path: '/static/icons/link.png' }, { name: 'phone', path: '/static/icons/phone.png' }, { name: 'website', path: '/static/icons/website.png' }, { name: 'xing', path: '/static/icons/xing.png' }, { name: 'mastodon', path: '/static/icons/mastodon.png' }, { name: 'stack-overflow', path: '/static/icons/stack-overflow.png' }, { name: 'gitlab', path: '/static/icons/gitlab.png' }, { name: 'bitbucket', path: '/static/icons/bitbucket.png' }, { name: 'codepen', path: '/static/icons/codepen.png' }, { name: 'dev-to', path: '/static/icons/dev-to.png' }, { name: 'freecodecamp', path: '/static/icons/freecodecamp.png' }, { name: 'hashnode', path: '/static/icons/hashnode.png' }, { name: 'product-hunt', path: '/static/icons/product-hunt.png' }, { name: 'unsplash', path: '/static/icons/unsplash.png' }, { name: 'patreon', path: '/static/icons/patreon.png' }, { name: 'buymeacoffee', path: '/static/icons/buymeacoffee.png' }, { name: 'ko-fi', path: '/static/icons/ko-fi.png' }, { name: 'slack', path: '/static/icons/slack.png' }, { name: 'teams', path: '/static/icons/teams.png' }, { name: 'skype', path: '/static/icons/skype.png' }, { name: 'google-scholar', path: '/static/icons/google-scholar.png' }, { name: 'researchgate', path: '/static/icons/researchgate.png' }, { name: 'academia-edu', path: '/static/icons/academia-edu.png' } ];
            let filteredIcons = [];
            let currentPage = 1;
            const iconsPerPage = 8;

            function renderIcons() {
                if (!iconsGrid) return;
                iconsGrid.innerHTML = '';
                const start = (currentPage - 1) * iconsPerPage;
                const end = start + iconsPerPage;
                const iconsToRender = filteredIcons.slice(start, end);

                if (iconsToRender.length === 0 && filteredIcons.length > 0 && currentPage > 1) {
                    currentPage--;
                    renderIcons();
                    return;
                }

                iconsToRender.forEach(icon => {
                    const iconElement = document.createElement('div');
                    iconElement.className = 'icon-option';
                    iconElement.innerHTML = `
                        <img src="${icon.path}" alt="${icon.name}">
                        <p>${icon.name.replace(/-/g, ' ')}</p>`;
                    iconElement.addEventListener('click', function () {
                        document.querySelectorAll('.icon-option').forEach(el => el.classList.remove('selected'));
                        this.classList.add('selected');
                    });
                    iconsGrid.appendChild(iconElement);
                });
                updatePaginationControls();
            }

            function updatePaginationControls() {
                if (!currentPageSpan || !prevIconPageBtn || !nextIconPageBtn) return;
                const totalPages = Math.ceil(filteredIcons.length / iconsPerPage);
                currentPageSpan.textContent = currentPage;
                prevIconPageBtn.disabled = currentPage === 1;
                nextIconPageBtn.disabled = currentPage >= totalPages || filteredIcons.length === 0;
            }

            function filterAndRenderIcons() {
                if (!iconSearchInput) return;
                const searchTerm = iconSearchInput.value.toLowerCase().trim();
                if (searchTerm === '') {
                    filteredIcons = [...allSocialIcons];
                } else {
                    filteredIcons = allSocialIcons.filter(icon =>
                        icon.name.toLowerCase().includes(searchTerm)
                    );
                }
                currentPage = 1;
                renderIcons();
            }

            function closeModals() {
                if(iconModal) iconModal.classList.remove('active', 'show');
                if(buttonModal) buttonModal.classList.remove('active', 'show');
                document.body.classList.remove('modal-open');
                currentModalPurpose = '';
            }

            if(iconSearchInput) iconSearchInput.addEventListener('input', filterAndRenderIcons);
            if(prevIconPageBtn) prevIconPageBtn.addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderIcons(); } });
            if(nextIconPageBtn) nextIconPageBtn.addEventListener('click', () => { const totalPages = Math.ceil(filteredIcons.length / iconsPerPage); if (currentPage < totalPages) { currentPage++; renderIcons(); } });

            if(addIconBtn) addIconBtn.addEventListener('click', () => {
                currentModalPurpose = 'social';
                filterAndRenderIcons();
                iconModal.classList.add('show');
                document.body.classList.add('modal-open');
                setTimeout(() => iconModal.classList.add('active'), 50);
            });

            if(addCardLinkBtn) addCardLinkBtn.addEventListener('click', () => {
                const currentCardLinksCount = document.querySelectorAll('#card-links-container .card-link-item').length;
                if (currentCardLinksCount >= 3) {
                    alert('Você pode adicionar no máximo 3 links ao cartão de visitas.');
                    return;
                }
                currentModalPurpose = 'card_link';
                filterAndRenderIcons();
                iconModal.classList.add('show');
                document.body.classList.add('modal-open');
                setTimeout(() => iconModal.classList.add('active'), 50);
            });

            const saveIconBtn = document.getElementById('save-icon');
            if(saveIconBtn) saveIconBtn.addEventListener('click', function (event) {
                event.preventDefault();
                const selectedIcon = document.querySelector('.icon-option.selected');
                if (selectedIcon) {
                    const iconName = selectedIcon.querySelector('p').textContent.toLowerCase().replace(/ /g, '-');
                    const iconPath = `/static/icons/${iconName}.png`; 

                    let targetContainer, itemClass, inputNameForCheck, itemHTML;
                    if (currentModalPurpose === 'social') {
                        targetContainer = socialIconsContainer;
                        itemClass = 'social-item';
                        inputNameForCheck = 'social_icon_name[]';
                        itemHTML = `
                            <i class="fas fa-grip-vertical drag-handle"></i> <img src="${iconPath}" alt="${iconName}" width="24">
                            <input type="hidden" name="social_icon_name[]" value="${escapeHtml(iconName)}">
                            <input type="text" name="social_icon_url[]"
                                        placeholder="Insira o link para ${iconName.replace(/-/g, ' ')}"
                                        class="form-input" required>
                            <span class="remove-item"><i class="fas fa-times"></i></span>`;
                    } else if (currentModalPurpose === 'card_link') {
                        targetContainer = cardLinksContainer;
                        itemClass = 'card-link-item';
                        inputNameForCheck = 'card_icon_name[]';
                        itemHTML = `
                            <i class="fas fa-grip-vertical drag-handle"></i> <img src="${iconPath}" alt="${iconName}" width="24">
                            <input type="hidden" name="card_icon_name[]" value="${escapeHtml(iconName)}">
                            <div class="input-group">
                                <input type="text" name="card_icon_url[]"
                                            placeholder="URL (Opcional)"
                                            class="form-input">
                                <input type="text" name="card_icon_at_text[]"
                                            placeholder="@texto"
                                            class="form-input">
                            </div>
                            <span class="remove-item"><i class="fas fa-times"></i></span>`;
                    } else { return; }

                    let iconExists = false;
                    if(targetContainer) {
                        targetContainer.querySelectorAll(`input[name="${inputNameForCheck}"]`).forEach(input => {
                            if (input.value === iconName) iconExists = true;
                        });
                    }


                    if (iconExists) { alert('Este ícone já foi adicionado!'); closeModals(); return; }

                    const newItemField = document.createElement('div');
                    newItemField.className = itemClass;
                    newItemField.innerHTML = itemHTML;
                    if(targetContainer) targetContainer.appendChild(newItemField);
                    
                    const firstInput = newItemField.querySelector('input[type="text"]');
                    if (firstInput) firstInput.focus();

                    newItemField.querySelector('.remove-item').addEventListener('click', function () {
                        this.closest(`.${itemClass}`).remove();
                    });
                    closeModals();
                } else {
                    alert('Por favor, selecione um ícone primeiro!');
                }
            });

            const buttonHasBorderCheckbox = document.getElementById('button-has-border');
            const borderOptionsGroup = document.getElementById('border-options-group');

            if(buttonHasBorderCheckbox) buttonHasBorderCheckbox.addEventListener('change', function() {
                if(borderOptionsGroup) borderOptionsGroup.style.display = this.checked ? 'flex' : 'none';
                updateButtonPreview(); 
            });

            const liveButtonPreview = document.getElementById('live-button-preview');
            const buttonTextInput = document.getElementById('button-text'); 
            const buttonColorInput = document.getElementById('button-color');
            const buttonRadiusInput = document.getElementById('button-radius');
            const radiusValueSpan = document.getElementById('radius-value');
            const buttonTextColorInput = document.getElementById('button-text-color');
            const buttonTextBoldCheckbox = document.getElementById('button-text-bold');
            const buttonTextItalicCheckbox = document.getElementById('button-text-italic');
            const buttonFontSizeInput = document.getElementById('button-font-size');
            const buttonBorderColorInput = document.getElementById('button-border-color');
            const buttonBorderWidthInput = document.getElementById('button-border-width');
            const buttonHasHoverCheckbox = document.getElementById('button-has-hover');
            const buttonShadowTypeSelect = document.getElementById('button-shadow-type'); 

            function updateButtonPreview() {
                if (!liveButtonPreview || !buttonTextInput || !buttonColorInput || !buttonRadiusInput || !radiusValueSpan || !buttonTextColorInput || !buttonTextBoldCheckbox || !buttonTextItalicCheckbox || !buttonFontSizeInput || !buttonHasBorderCheckbox || !buttonBorderColorInput || !buttonBorderWidthInput || !buttonHasHoverCheckbox || !buttonShadowTypeSelect) return;

                liveButtonPreview.textContent = buttonTextInput.value || 'Texto do Botão';
                liveButtonPreview.style.backgroundColor = buttonColorInput.value;
                liveButtonPreview.style.borderRadius = `${buttonRadiusInput.value}px`;
                radiusValueSpan.textContent = `${buttonRadiusInput.value}px`;
                liveButtonPreview.style.color = buttonTextColorInput.value;
                liveButtonPreview.style.fontWeight = buttonTextBoldCheckbox.checked ? 'bold' : 'normal';
                liveButtonPreview.style.fontStyle = buttonTextItalicCheckbox.checked ? 'italic' : 'normal';
                liveButtonPreview.style.fontSize = `${buttonFontSizeInput.value}px`;

                if (buttonHasBorderCheckbox.checked) {
                    liveButtonPreview.style.border = `${buttonBorderWidthInput.value}px solid ${buttonBorderColorInput.value}`;
                } else {
                    liveButtonPreview.style.border = 'none';
                }

                ['shadow-soft', 'shadow-medium', 'shadow-hard', 'shadow-inset'].forEach(cls => liveButtonPreview.classList.remove(cls));
                if (buttonShadowTypeSelect.value !== 'none') {
                    liveButtonPreview.classList.add(`shadow-${buttonShadowTypeSelect.value}`);
                }
                liveButtonPreview.classList.toggle('hover-effect-preview', buttonHasHoverCheckbox.checked);
            }
            
            [buttonTextInput, buttonColorInput, buttonRadiusInput, buttonTextColorInput, buttonTextBoldCheckbox, buttonTextItalicCheckbox, buttonFontSizeInput, buttonBorderColorInput, buttonBorderWidthInput, buttonHasHoverCheckbox, buttonShadowTypeSelect].forEach(el => {
                if (el) el.addEventListener(el.type === 'checkbox' || el.type === 'select-one' ? 'change' : 'input', updateButtonPreview);
            });


            if(addButtonBtn) addButtonBtn.addEventListener('click', () => {
                if(buttonTextInput) buttonTextInput.value = '';
                const buttonLinkInput = document.getElementById('button-link');
                if(buttonLinkInput) buttonLinkInput.value = '';
                if(buttonColorInput) buttonColorInput.value = '#4CAF50';
                if(buttonRadiusInput) buttonRadiusInput.value = '10';
                if(radiusValueSpan) radiusValueSpan.textContent = '10px';
                if(buttonTextColorInput) buttonTextColorInput.value = '#FFFFFF';
                if(buttonTextBoldCheckbox) buttonTextBoldCheckbox.checked = false;
                if(buttonTextItalicCheckbox) buttonTextItalicCheckbox.checked = false;
                if(buttonFontSizeInput) buttonFontSizeInput.value = '16';
                if(buttonHasBorderCheckbox) buttonHasBorderCheckbox.checked = false;
                if(borderOptionsGroup) borderOptionsGroup.style.display = 'none';
                if(buttonBorderColorInput) buttonBorderColorInput.value = '#000000';
                if(buttonBorderWidthInput) buttonBorderWidthInput.value = '2';
                if(buttonHasHoverCheckbox) buttonHasHoverCheckbox.checked = false;
                if(buttonShadowTypeSelect) buttonShadowTypeSelect.value = 'none'; 
                updateButtonPreview(); 

                if(buttonModal) {
                    buttonModal.classList.add('show');
                    document.body.classList.add('modal-open');
                    setTimeout(() => buttonModal.classList.add('active'), 50);
                }
            });
            
            const saveButtonBtn = document.getElementById('save-button');
            if(saveButtonBtn) saveButtonBtn.addEventListener('click', function (event) {
                event.preventDefault();
                const btnText = buttonTextInput.value; 
                const btnLink = document.getElementById('button-link').value; 
                
                if (btnText && btnLink) {
                    const newButtonData = {
                        text: btnText,
                        link: btnLink,
                        color: buttonColorInput.value,
                        radius: buttonRadiusInput.value,
                        textColor: buttonTextColorInput.value,
                        bold: buttonTextBoldCheckbox.checked,
                        italic: buttonTextItalicCheckbox.checked,
                        fontSize: buttonFontSizeInput.value,
                        hasBorder: buttonHasBorderCheckbox.checked,
                        borderColor: buttonBorderColorInput.value,
                        borderWidth: buttonBorderWidthInput.value,
                        hasHoverEffect: buttonHasHoverCheckbox.checked,
                        shadowType: buttonShadowTypeSelect.value 
                    };
                    
                    renderCustomButton(newButtonData);
                    closeModals();
                } else {
                    alert('Por favor, preencha o texto e o link do botão!');
                }
            });

            if(iconModalCloseBtn) iconModalCloseBtn.addEventListener('click', closeModals);
            if(buttonModalCloseBtn) buttonModalCloseBtn.addEventListener('click', closeModals);

            window.addEventListener('click', function (event) {
                if (event.target === iconModal || event.target === buttonModal) {
                    closeModals();
                }
            });

            document.querySelectorAll('.social-item .remove-item, .custom-button-item .remove-item, .card-link-item .remove-item').forEach(item => {
                item.addEventListener('click', function() {
                    this.closest('.social-item, .custom-button-item, .card-link-item').remove();
                });
            });

            const cardBgTypeRadios = document.querySelectorAll('input[name="card_background_type"]');
            const cardBgColorPicker = document.getElementById('card_background_color_picker');
            const cardBgImageUploadSection = document.getElementById('card_background_image_upload_section');

            function updateCardBackgroundVisibility() {
                if (!cardBgColorPicker || !cardBgImageUploadSection) return;
                const selectedTypeRadio = document.querySelector('input[name="card_background_type"]:checked');
                if (!selectedTypeRadio) return; 
                const selectedType = selectedTypeRadio.value;

                cardBgColorPicker.style.display = selectedType === 'color' ? 'inline-block' : 'none';
                cardBgImageUploadSection.style.display = selectedType === 'image' ? 'block' : 'none';
            }

            cardBgTypeRadios.forEach(radio => {
                radio.addEventListener('change', updateCardBackgroundVisibility);
            });
            updateCardBackgroundVisibility(); 

        }); 
    </script>
    <script src="{{ url_for('static', filename='js/dark-mode.js') }}"></script>
    <a href="/{{ dados.profile }}" class="preview-float-btn">
        <i class="fas fa-eye"></i>
        <span class="preview-float-tooltip">Visualizar Página</span>
    </a>
</body>
</html>