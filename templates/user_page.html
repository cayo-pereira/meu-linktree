<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>{{ dados.nome if dados.nome else 'Perfil' }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <style>
        /* Estilos dinâmicos podem ser injetados aqui pelo Flask se necessário,
           mas tentaremos aplicar inline para os elementos específicos. */

        /* NOVAS ANIMAÇÕES PARA AS SETAS DO SWIPER */
        @keyframes subtle-bounce-right {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(4px); } /* Movimento sutil para a direita */
        }

        @keyframes subtle-bounce-left {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(-4px); } /* Movimento sutil para a esquerda */
        }

        /* Aplica a animação ao pseudo-elemento ::after que contém o ícone da seta */
        .swiper-button-next.swiper-arrow-animated::after {
            animation: subtle-bounce-right 0.8s ease-in-out infinite;
        }

        .swiper-button-prev.swiper-arrow-animated::after {
            animation: subtle-bounce-left 0.8s ease-in-out infinite;
        }

        /* Garante que a animação não rode se a seta estiver explicitamente desabilitada pelo Swiper */
        .swiper-button-disabled.swiper-arrow-animated::after {
            animation: none !important;
        }
    </style>
</head>
{% if session.logado and session.profile == dados.profile %}
<div style="position: fixed; bottom: 20px; right: 20px; z-index: 1001; /* Acima do swiper-pagination */">
    <a href="{{ url_for('admin_panel', username=dados.profile) }}"
        style="background: #4361ee; color: white; padding: 10px 15px; border-radius: 8px; text-decoration: none; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
        <i class="fas fa-edit"></i> Editar Página
    </a>
</div>
{% endif %}

<body {% if dados.background
    %}style="background-image: url('{{ dados.background if dados.background.startswith('http') else url_for('static', filename=dados.background) }}'); background-size: cover; background-position: center; background-attachment: fixed;"
    {% else %}
    style="background-color: #000;" /* Fallback se não houver imagem de fundo */
    {% endif %}>
    <div class="swiper-container">
        <div class="swiper-wrapper">
            <div class="swiper-slide user-page-slide">
                <div class="container">
                    {% if dados.foto %}
                    <img src="{{ dados.foto if dados.foto.startswith('http') else url_for('static', filename=dados.foto) }}"
                        alt="Foto de perfil" class="profile-pic">
                    {% endif %}

                    <h1 style="font-family: {{ dados.nome_font | style_safe | default('Inter, sans-serif', true) }}; color: {{ dados.nome_color | default('#FFFFFF', true) }};">
                        {{ dados.nome if dados.nome else 'Usuário' }}
                    </h1>

                    {% if dados.bio %}
                    <p class="bio" style="font-family: {{ dados.bio_font | style_safe | default('Inter, sans-serif', true) }}; color: {{ dados.bio_color | default('#CCCCCC', true) }};">
                        {{ dados.bio }}
                    </p>
                    {% endif %}

                    <div class="social-icons">
                        {% for link in dados.social_links %}
                        <a href="{{ link.url }}" target="_blank" title="{{ link.icon | replace('-', ' ') | title }}">
                            <img src="/static/icons/{{ link.icon }}.png" class="icon" alt="{{ link.icon | replace('-', ' ') | title }}">
                        </a>
                        {% endfor %}
                    </div>

                    {% if dados.custom_buttons %}
                    <div class="custom-buttons-container">
                        {% for button in dados.custom_buttons %}
                        <a href="{{ button.link }}"
                            class="link-button-custom
                                    {% if button.hasHoverEffect %}has-hover-effect{% endif %}
                                    {% if button.shadowType and button.shadowType != 'none' %}shadow-{{ button.shadowType }}{% endif %}"
                            style="background: {{ button.color }};
                                            border-radius: {{ button.radius }}px;
                                            color: {{ button.textColor }};
                                            font-weight: {{ 'bold' if button.bold else 'normal' }};
                                            font-style: {{ 'italic' if button.italic else 'normal' }};
                                            font-size: {{ button.fontSize }}px;
                                            {% if button.hasBorder %}border: {{ button.borderWidth }}px solid {{ button.borderColor }};{% else %}border: none;{% endif %}" target="_blank">
                            {{ button.text }}
                        </a>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <footer>
                        <p>Desenvolvido por CPages ✨</p>
                    </footer>
                </div>
            </div>

            <div class="swiper-slide card-page-slide">
                <div class="card-container"
                    style="{% if dados.card_background_type == 'color' %}background-color: {{ dados.card_background_value | default('#4361ee', true) }};{% elif dados.card_background_type == 'image' and dados.card_background_value %}background-image: url('{{ dados.card_background_value if dados.card_background_value.startswith('http') else url_for('static', filename=dados.card_background_value) }}'); background-size: cover; background-position: center;{% else %}background-color: #4361ee;{% endif %}">
                    <div class="card-content">
                        <div class="card-header-info">
                            <h2 style="font-family: {{ dados.card_nome_font | style_safe | default('Inter, sans-serif', true) }}; color: {{ dados.card_nome_color | default('#FFFFFF', true) }};">
                                {{ dados.card_nome if dados.card_nome else dados.nome }}
                            </h2>
                            {% if dados.card_titulo %}
                            <p class="card-title" style="font-family: {{ dados.card_titulo_font | style_safe | default('Inter, sans-serif', true) }}; color: {{ dados.card_titulo_color | default('#EEEEEE', true) }};">
                                {{ dados.card_titulo }}
                            </p>
                            {% endif %}
                            {% if dados.card_registro_profissional %}
                            <p class="card-registration" style="font-family: {{ dados.card_registro_font | style_safe | default('Inter, sans-serif', true) }}; color: {{ dados.card_registro_color | default('#BBBBBB', true) }};">
                                {{ dados.card_registro_profissional }}
                            </p>
                            {% endif %}
                        </div>

                        <div class="card-links-and-button">
                            <div class="card-links">
                                {% for link in dados.card_links %}
                                <a href="{{ link.url if link.url else '#' }}" target="_blank" class="card-link-item"
                                    title="{{ link.at_text if link.at_text else (link.icon | replace('-', ' ') | title) }}">
                                    <img src="/static/icons/{{ link.icon }}.png" class="card-icon" alt="{{ link.icon | replace('-', ' ') | title }}">
                                    {% if link.at_text %}
                                    <span class="card-link-text" style="color: {{ dados.card_link_text_color | default('#FFFFFF', true) }};">{{ link.at_text }}</span>
                                    {% endif %}
                                </a>
                                {% endfor %}
                            </div>

                            <button class="add-to-contacts-btn" onclick="addToContacts()">
                                <i class="fas fa-address-book"></i> Salvar Contato
                            </button>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <div class="swiper-pagination"></div>

        <div class="swiper-button-prev"></div>
        <div class="swiper-button-next"></div>

    </div>

    <script>
        document.body.style.opacity = 0;
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                document.body.style.opacity = 1;
            }, 100);

            const userPageSlide = document.querySelector('.user-page-slide');

            if (userPageSlide) {
                userPageSlide.addEventListener('wheel', function (event) {
                    const el = this;
                    const scrollHeight = el.scrollHeight;
                    const clientHeight = el.clientHeight;
                    const scrollTop = el.scrollTop;
                    const deltaY = event.deltaY;

                    if (scrollHeight <= clientHeight) {
                        return;
                    }

                    const atTop = scrollTop <= 0;
                    const atBottom = scrollTop >= (scrollHeight - clientHeight - 1);

                    if ((deltaY < 0 && atTop) || (deltaY > 0 && atBottom)) {
                        return;
                    } else {
                        event.stopPropagation();
                        el.scrollTop += deltaY;
                    }
                }, { passive: true });
            }

            function applyArrowAnimation(swiperInstance) {
                const prevEl = swiperInstance.navigation.prevEl;
                const nextEl = swiperInstance.navigation.nextEl;

                if (!prevEl || !nextEl) {
                    return;
                }

                prevEl.classList.remove('swiper-arrow-animated');
                nextEl.classList.remove('swiper-arrow-animated');

                if (!swiperInstance.isEnd) {
                    nextEl.classList.add('swiper-arrow-animated');
                }
                if (!swiperInstance.isBeginning) {
                    prevEl.classList.add('swiper-arrow-animated');
                }
            }

            const swiper = new Swiper('.swiper-container', {
                effect: 'creative',
                creativeEffect: {
                    prev: {
                        shadow: false,
                        translate: ['-120%', 0, -500],
                    },
                    next: {
                        shadow: false,
                        translate: ['120%', 0, -500],
                    },
                },
                grabCursor: true,
                pagination: {
                    el: '.swiper-pagination',
                    clickable: true,
                },
                navigation: {
                    nextEl: '.swiper-button-next',
                    prevEl: '.swiper-button-prev',
                },
                loop: false,
                simulateTouch: true,
                mousewheel: {
                    enabled: true,
                    releaseOnEdges: true,
                },
                observer: true,
                observeParents: true,
                on: {
                    init: function () {
                        applyArrowAnimation(this);
                    },
                    slideChangeTransitionEnd: function () {
                        applyArrowAnimation(this);
                    }
                }
            });
        });

        // Passa os dados dos links do cartão como um objeto JSON para o JavaScript
        const cardLinksData = {{ dados.card_links | tojson | safe }};

        function addToContacts() {
            const sanitizeVCardString = (str) => {
                if (typeof str !== 'string') return '';
                let cleanedStr = str.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, ''); // Remove caracteres de controle problemáticos
                cleanedStr = cleanedStr.replace(/\\/g, '\\\\'); // Escapa barras invertidas
                cleanedStr = cleanedStr.replace(/,/g, '\\,');   // Escapa vírgulas
                cleanedStr = cleanedStr.replace(/;/g, '\\;');   // Escapa ponto e vírgula
                cleanedStr = cleanedStr.replace(/\n/g, '\\n');  // Converte novas linhas para literal \n
                return cleanedStr;
            };
            
            // Sanitize o nome do perfil para o nome do arquivo .vcf
            const sanitizeForFilename = (str) => {
                if (typeof str !== 'string') return 'contato';
                return str.replace(/[^a-z0-9_\-]/ig, '_');
            };

            const cardNome = sanitizeVCardString("{{ dados.card_nome if dados.card_nome else dados.nome }}");
            const cardTitulo = sanitizeVCardString("{{ dados.card_titulo }}");
            const cardRegistro = sanitizeVCardString("{{ dados.card_registro_profissional }}");
            const email = sanitizeVCardString("{{ dados.email }}");

            let vCardData = `BEGIN:VCARD
VERSION:3.0
N:${cardNome};;;;
FN:${cardNome}`;
            if (cardTitulo) vCardData += `\nTITLE:${cardTitulo}`;
            if (cardRegistro) vCardData += `\nORG:${cardRegistro}`;
            if (email) vCardData += `\nEMAIL;TYPE=INTERNET,PREF:${email}`;

            // Itera sobre o array JavaScript cardLinksData
            if (Array.isArray(cardLinksData)) {
                cardLinksData.forEach(link => {
                    const icon_type = link.icon ? link.icon.toLowerCase() : "";
                    // Sanitize link.url e link.at_text aqui dentro do JavaScript
                    const link_url_original = link.url || "";
                    const link_at_text_original = link.at_text || "";

                    const link_url_sanitized = sanitizeVCardString(link_url_original);
                    const link_at_text_sanitized = sanitizeVCardString(link_at_text_original);
                    
                    let iconNameForNote = link.icon ? link.icon.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : "Contato";


                    if (icon_type.includes('whatsapp') || icon_type.includes('phone') || link_url_original.startsWith('tel:')) {
                        let phone_number = link_url_original.replace('tel:', '').replace('https://wa.me/', '');
                        if (phone_number) {
                             // Remove query params de números de telefone (ex: ?text=)
                            vCardData += `\nTEL;TYPE=CELL:${sanitizeVCardString(phone_number.split('?')[0])}`;
                        }
                    } else if (icon_type.includes('mail') || icon_type.includes('email') || link_url_original.startsWith('mailto:')) {
                        let email_address = link_url_original.replace('mailto:', '');
                        if (email_address) {
                            // Remove query params de emails (ex: ?subject=)
                            vCardData += `\nEMAIL;TYPE=INTERNET:${sanitizeVCardString(email_address.split('?')[0])}`;
                        }
                    } else if (link_url_original) { // Se for um URL genérico
                        // Usar X-SOCIALPROFILE para redes sociais conhecidas
                        if (icon_type.includes('linkedin')) {
                            vCardData += `\nX-SOCIALPROFILE;TYPE=linkedin:${link_url_sanitized}`;
                        } else if (icon_type.includes('twitter') || icon_type.includes('x-com')) {
                            vCardData += `\nX-SOCIALPROFILE;TYPE=twitter:${link_url_sanitized}`;
                        } else if (icon_type.includes('instagram')) {
                            vCardData += `\nX-SOCIALPROFILE;TYPE=instagram:${link_url_sanitized}`;
                        } else if (icon_type.includes('facebook')) {
                            vCardData += `\nX-SOCIALPROFILE;TYPE=facebook:${link_url_sanitized}`;
                        } else { // Para outros links, usar URL padrão
                            vCardData += `\nURL;TYPE=${sanitizeVCardString(iconNameForNote.replace(/ /g,''))}:${link_url_sanitized}`;
                        }
                    }

                    // Adiciona o @texto como uma nota, se existir
                    if (link_at_text_original) {
                        // Ajusta o prefixo da nota para ser mais descritivo
                        if (icon_type.includes('linkedin') && !link_url_original) {
                             iconNameForNote = 'LinkedIn Handle';
                        } else if ((icon_type.includes('twitter') || icon_type.includes('x-com')) && !link_url_original) {
                             iconNameForNote = 'Twitter/X Handle';
                             // Garante que o @texto para twitter/X comece com @ se não tiver
                             if (!link_at_text_original.startsWith('@')) {
                                 link_at_text_sanitized = sanitizeVCardString('@' + link_at_text_original);
                             }
                        } else if (icon_type.includes('instagram') && !link_url_original) {
                             iconNameForNote = 'Instagram Handle';
                             if (!link_at_text_original.startsWith('@')) {
                                 link_at_text_sanitized = sanitizeVCardString('@' + link_at_text_original);
                             }
                        }
                        vCardData += `\nNOTE:${iconNameForNote}: ${link_at_text_sanitized}`;
                    }
                });
            }

            {% if dados.foto and dados.foto.startswith('http') %}
            // Adicionar foto via URL é menos suportado, mas pode ser incluído se desejado.
            // vCardData += `\nPHOTO;VALUE=URL:{{ dados.foto }}`;
            {% endif %}

            vCardData += `\nEND:VCARD`;

            const blob = new Blob([vCardData], { type: 'text/vcard;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            // Usa a função de sanitização para o nome do arquivo
            const profileNameForFile = sanitizeForFilename("{{ dados.profile | default('contato', true) }}");
            a.download = `contato_${profileNameForFile}.vcf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>

</html>