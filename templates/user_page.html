<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>{{ dados.nome if dados.nome else 'Perfil' }}</title>

    <meta property="og:title" content="{{ dados.nome if dados.nome else 'Perfil Pessoal' }}">
    <meta property="og:description"
        content="{{ (dados.bio | striptags | truncate(150)) if dados.bio else 'Confira esta página!' }}">
    <meta property="og:url"
        content="{{ request.url_root.rstrip('/') }}{{ url_for('user_page', profile=dados.profile) }}">
    {% if dados.foto %}
    <meta property="og:image"
        content="{{ dados.foto if dados.foto.startswith('http') else url_for('static', filename=dados.foto, _external=True) }}">
    {% else %}
    {% endif %}
    <meta property="og:type" content="profile">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <style>
        /* Animações de seta (coloque as suas aqui se as removeu) */
        @keyframes subtle-bounce-right {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(4px); }
        }
        @keyframes subtle-bounce-left {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(-4px); }
        }
        .swiper-button-next.swiper-arrow-animated::after {
            animation: subtle-bounce-right 0.8s ease-in-out infinite;
        }
        .swiper-button-prev.swiper-arrow-animated::after {
            animation: subtle-bounce-left 0.8s ease-in-out infinite;
        }
        .swiper-button-disabled.swiper-arrow-animated::after {
            animation: none !important;
        }

        /* Estilos para o botão de partilha */
        #share-button-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1005;
            background-color: rgba(255, 255, 255, 0.85);
            color: #333;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        #share-button-container:hover {
            background-color: rgba(240, 240, 240, 0.95);
            transform: scale(1.1);
        }
        #share-button-container i {
            font-size: 20px;
        }

        /* Estilos para o Modal de Fallback da Partilha */
        #share-fallback-modal {
            display: none !important; /* MUITO IMPORTANTE */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 15px;
            box-sizing: border-box;
        }
        .share-fallback-content {
            background-color: #fff;
            color: #333;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            max-width: 350px;
            width: 100%;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .share-fallback-content h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.3em;
            color: #4361ee;
        }
        .share-fallback-content p {
            margin-bottom: 15px;
            font-size: 0.9em;
            white-space: pre-wrap;
            color: #555;
            max-height: 100px;
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 8px;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .share-fallback-content input[type="text"] {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9em;
            box-sizing: border-box;
        }
        .share-fallback-content button,
        .share-fallback-content a.share-fallback-btn {
            display: inline-block;
            padding: 10px 18px;
            margin: 8px 5px;
            border-radius: 5px;
            text-decoration: none;
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
        }
        .share-fallback-btn-primary {
            background-color: #4361ee;
            color: white;
        }
        .share-fallback-btn-primary:hover {
            background-color: #3f37c9;
            transform: translateY(-1px);
        }
        .share-fallback-btn-whatsapp {
            background-color: #25D366;
            color: white;
        }
        .share-fallback-btn-whatsapp:hover {
            background-color: #1DAE52;
            transform: translateY(-1px);
        }
        .share-fallback-btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .share-fallback-btn-secondary:hover {
            background-color: #5a6268;
        }
    </style>
</head>

{% if session.logado and session.profile == dados.profile %}
<div style="position: fixed; bottom: 20px; right: 20px; z-index: 1001;">
    <a href="{{ url_for('admin_panel', username=dados.profile) }}"
        style="background: #4361ee; color: white; padding: 10px 15px; border-radius: 8px; text-decoration: none; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
        <i class="fas fa-edit"></i> Editar Página
    </a>
</div>
{% endif %}

<div id="share-button-container" title="Compartilhar">
    <i class="fas fa-share-nodes"></i>
</div>

<div id="share-fallback-modal">
    <div class="share-fallback-content">
        <h3>Compartilhar</h3>
        <p id="fallback-text-content">Conteúdo da partilha aqui.</p>
        <input type="text" id="fallback-url-input" readonly title="URL para compartilhar">
        <button id="copy-fallback-url-button" class="share-fallback-btn-primary" title="Copiar URL">
            <i class="fas fa-copy"></i> Copiar URL
        </button>
        <a id="whatsapp-fallback-link" href="#" target="_blank" class="share-fallback-btn share-fallback-btn-whatsapp"
            title="Compartilhar no WhatsApp">
            <i class="fab fa-whatsapp"></i> WhatsApp
        </a>
        <button id="close-fallback-modal-button" class="share-fallback-btn-secondary">Fechar</button>
    </div>
</div>


<body {% if dados.background
    %}style="background-image: url('{{ dados.background if dados.background.startswith('http') else url_for('static', filename=dados.background) }}'); background-size: cover; background-position: center; background-attachment: fixed;"
    {% else %} style="background-color: #000;" {% endif %}>
    <div class="swiper-container">
        <div class="swiper-wrapper">
            <div class="swiper-slide user-page-slide">
                <div class="container">
                    {% if dados.foto %}
                    <img src="{{ dados.foto if dados.foto.startswith('http') else url_for('static', filename=dados.foto) }}"
                        alt="Foto de perfil" class="profile-pic">
                    {% endif %}

                    <h1
                        style="font-family: {{ dados.nome_font | style_safe | default('Inter, sans-serif', true) }}; color: {{ dados.nome_color | default('#FFFFFF', true) }};">
                        {{ dados.nome if dados.nome else 'Usuário' }}
                    </h1>

                    {% if dados.bio %}
                    <p class="bio"
                        style="font-family: {{ dados.bio_font | style_safe | default('Inter, sans-serif', true) }}; color: {{ dados.bio_color | default('#CCCCCC', true) }};">
                        {{ dados.bio }}
                    </p>
                    {% endif %}

                    <div class="social-icons">
                        {% for link in dados.social_links %}
                        <a href="{{ link.url }}" target="_blank" title="{{ link.icon | replace('-', ' ') | title }}">
                            <img src="/static/icons/{{ link.icon }}.png" class="icon"
                                alt="{{ link.icon | replace('-', ' ') | title }}">
                        </a>
                        {% endfor %}
                    </div>

                    {% if dados.custom_buttons %}
                    <div class="custom-buttons-container">
                        {% for button in dados.custom_buttons %}
                        <a href="{{ button.link }}"
                            class="link-button-custom {% if button.hasHoverEffect %}has-hover-effect{% endif %} {% if button.shadowType and button.shadowType != 'none' %}shadow-{{ button.shadowType }}{% endif %}"
                            style="background: {{ button.color }}; border-radius: {{ button.radius }}px; color: {{ button.textColor }}; font-weight: {{ 'bold' if button.bold else 'normal' }}; font-style: {{ 'italic' if button.italic else 'normal' }}; font-size: {{ button.fontSize }}px; {% if button.hasBorder %}border: {{ button.borderWidth }}px solid {{ button.borderColor }};{% else %}border: none;{% endif %}"
                            target="_blank">
                            {{ button.text }}
                        </a>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <footer>
                        <p>Desenvolvido por CPages ✨</p>
                    </footer>
                </div>
            </div>

            <div class="swiper-slide card-page-slide">
                <div class="card-container"
                    style="{% if dados.card_background_type == 'color' %}background-color: {{ dados.card_background_value | default('#4361ee', true) }};{% elif dados.card_background_type == 'image' and dados.card_background_value %}background-image: url('{{ dados.card_background_value if dados.card_background_value.startswith('http') else url_for('static', filename=dados.card_background_value) }}'); background-size: cover; background-position: center;{% else %}background-color: #4361ee;{% endif %}">
                    <div class="card-content">
                        <div class="card-header-info">
                            <h2
                                style="font-family: {{ dados.card_nome_font | style_safe | default('Inter, sans-serif', true) }}; color: {{ dados.card_nome_color | default('#FFFFFF', true) }};">
                                {{ dados.card_nome if dados.card_nome else dados.nome }}
                            </h2>
                            {% if dados.card_titulo %}
                            <p class="card-title"
                                style="font-family: {{ dados.card_titulo_font | style_safe | default('Inter, sans-serif', true) }}; color: {{ dados.card_titulo_color | default('#EEEEEE', true) }};">
                                {{ dados.card_titulo }}
                            </p>
                            {% endif %}
                            {% if dados.card_registro_profissional %}
                            <p class="card-registration"
                                style="font-family: {{ dados.card_registro_font | style_safe | default('Inter, sans-serif', true) }}; color: {{ dados.card_registro_color | default('#BBBBBB', true) }};">
                                {{ dados.card_registro_profissional }}
                            </p>
                            {% endif %}
                        </div>

                        <div class="card-links-and-button">
                            <div class="card-links">
                                {% for link in dados.card_links %}
                                <a href="{{ link.url if link.url else '#' }}" target="_blank" class="card-link-item"
                                    title="{{ link.at_text if link.at_text else (link.icon | replace('-', ' ') | title) }}">
                                    <img src="/static/icons/{{ link.icon }}.png" class="card-icon"
                                        alt="{{ link.icon | replace('-', ' ') | title }}">
                                    {% if link.at_text %}
                                    <span class="card-link-text"
                                        style="color: {{ dados.card_link_text_color | default('#FFFFFF', true) }};">{{
                                        link.at_text }}</span>
                                    {% endif %}
                                </a>
                                {% endfor %}
                            </div>
                            <button class="add-to-contacts-btn" onclick="addToContacts()">
                                <i class="fas fa-address-book"></i> Salvar Contato
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="swiper-pagination"></div>
        <div class="swiper-button-prev"></div>
        <div class="swiper-button-next"></div>
    </div>

<script>
    console.log("DEBUG: Script principal iniciado.");
    document.body.style.opacity = 0;

    window.addEventListener('DOMContentLoaded', () => {
        console.log("DEBUG: DOMContentLoaded acionado.");
        setTimeout(() => {
            document.body.style.opacity = 1;
            console.log("DEBUG: Opacidade do body definida para 1.");
        }, 100);

        const userPageSlide = document.querySelector('.user-page-slide');
        if (userPageSlide) {
            console.log("DEBUG: Elemento .user-page-slide encontrado.");
            userPageSlide.addEventListener('wheel', function (event) {
                const el = this;
                const scrollHeight = el.scrollHeight;
                const clientHeight = el.clientHeight;
                const scrollTop = el.scrollTop;
                const deltaY = event.deltaY;
                if (scrollHeight <= clientHeight) { return; }
                const atTop = scrollTop <= 0;
                const atBottom = scrollTop >= (scrollHeight - clientHeight - 1);
                if ((deltaY < 0 && atTop) || (deltaY > 0 && atBottom)) { return; }
                else { event.stopPropagation(); el.scrollTop += deltaY; }
            }, { passive: true });
        } else {
            console.error("DEBUG_ERROR: Elemento .user-page-slide NÃO encontrado!");
        }

        let swiperInstance = null; // Declarar swiperInstance aqui para que seja acessível
        try {
            console.log("DEBUG: Tentando definir applyArrowAnimation...");
            function applyArrowAnimation(currentSwiper) {
                console.log("DEBUG: applyArrowAnimation chamada.");
                if (!currentSwiper || !currentSwiper.navigation) {
                    console.warn("DEBUG_WARN: Instância Swiper ou navegação indefinida em applyArrowAnimation.");
                    return;
                }
                const prevEl = currentSwiper.navigation.prevEl;
                const nextEl = currentSwiper.navigation.nextEl;
                if (!prevEl || !nextEl) {
                    console.warn("DEBUG_WARN: Elementos de seta (prevEl ou nextEl) não encontrados em applyArrowAnimation.");
                    return;
                }
                prevEl.classList.remove('swiper-arrow-animated');
                nextEl.classList.remove('swiper-arrow-animated');
                if (!currentSwiper.isEnd) { nextEl.classList.add('swiper-arrow-animated'); }
                if (!currentSwiper.isBeginning) { prevEl.classList.add('swiper-arrow-animated'); }
                console.log("DEBUG: Animação de setas processada.");
            }
            console.log("DEBUG: applyArrowAnimation definida. Tentando inicializar Swiper...");

            swiperInstance = new Swiper('.swiper-container', {
                effect: 'creative',
                creativeEffect: {
                    prev: { shadow: false, translate: ['-120%', 0, -500], },
                    next: { shadow: false, translate: ['120%', 0, -500], },
                },
                grabCursor: true,
                pagination: { el: '.swiper-pagination', clickable: true, },
                navigation: { nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev', },
                loop: false,
                simulateTouch: true,
                mousewheel: { enabled: true, releaseOnEdges: true, },
                observer: true,
                observeParents: true,
                on: {
                    init: function () {
                        console.log("DEBUG: Swiper EVENTO init acionado!", this);
                        applyArrowAnimation(this);
                    },
                    slideChangeTransitionEnd: function () {
                        console.log("DEBUG: Swiper EVENTO slideChangeTransitionEnd acionado!", this);
                        applyArrowAnimation(this);
                    }
                }
            });
            console.log("DEBUG: Swiper inicializado com sucesso. Instância:", swiperInstance);
        } catch (e) {
            console.error("DEBUG_ERROR: ERRO CRÍTICO AO INICIALIZAR O SWIPER:", e);
        }

        // --- Lógica de Partilha ---
        try {
            console.log("DEBUG: Configurando lógica de partilha...");
            const shareButton = document.getElementById('share-button-container');
            if (shareButton) {
                console.log("DEBUG: Botão de partilha encontrado.");
                shareButton.addEventListener('click', async () => {
                    console.log("DEBUG: Botão de partilha CLICADO.");
                    if (!swiperInstance) {
                        console.error("DEBUG_ERROR: Instância do Swiper não disponível para partilha.");
                        alert("Erro: Funcionalidade de swipe não está pronta.");
                        return;
                    }
                    console.log("DEBUG: Instância Swiper disponível. Index atual:", swiperInstance.activeIndex);

                    const currentSlideIndex = swiperInstance.activeIndex;
                    let pageUrl = "";
                    try {
                        // Atenção aqui: Jinja renderiza no servidor. Isto será uma string JS constante.
                        pageUrl = {{ (request.url_root.rstrip('/') + url_for('user_page', profile=dados.profile)) | tojson | safe }};
                        console.log("DEBUG: pageUrl para partilha:", pageUrl);
                        if (!pageUrl) throw new Error("pageUrl é nulo ou vazio após renderização Jinja.");
                    } catch (e) {
                        console.error("DEBUG_ERROR: Erro ao gerar pageUrl com Jinja:", e);
                        console.error("DEBUG_INFO: Valor de dados.profile:", {{ dados.profile | tojson | safe }});
                        alert("Erro ao obter URL da página para partilha.");
                        return;
                    }

                    let shareData = { title: '', text: '', url: pageUrl };

                    if (currentSlideIndex === 0) {
                        console.log("DEBUG: Partilhando slide de PERFIL.");
                        shareData.title = {{ ('Confira o perfil de ' + (dados.nome if dados.nome else '')) | tojson | safe }};
                        shareData.text = {{ (dados.bio | striptags | truncate(120) if dados.bio else '') | tojson | safe }} + "\n\nVisite a página:";
                    } else {
                        console.log("DEBUG: Partilhando slide de CARTÃO.");
                        shareData.title = {{ ('Cartão de Visita: ' + (dados.card_nome if dados.card_nome else dados.nome if dados.nome else '')) | tojson | safe }};
                        let cardText = {{ (dados.card_titulo if dados.card_titulo else "") | tojson | safe }};
                        {% if dados.card_registro_profissional %}
                        if (cardText) cardText += "\n"; // JS \n
                        cardText += {{ dados.card_registro_profissional | tojson | safe }};
                        {% endif %}
                        if (cardText) cardText += "\n\n"; // JS \n
                        cardText += "Acesse o contato:";
                        shareData.text = cardText;
                    }
                    console.log("DEBUG: Dados para partilha:", JSON.stringify(shareData));

                    if (navigator.share) {
                        console.log("DEBUG: API navigator.share disponível. Tentando partilhar...");
                        try {
                            await navigator.share(shareData);
                            console.log("DEBUG: Conteúdo compartilhado com sucesso via navigator.share!");
                        } catch (err) {
                            console.warn("DEBUG_WARN: Erro ao usar navigator.share:", err);
                            if (err.name !== 'AbortError') { // Não mostrar fallback se o utilizador cancelou
                                showShareFallbackModal(shareData.url, shareData.title, shareData.text);
                            }
                        }
                    } else {
                        console.log("DEBUG: API navigator.share NÃO disponível. Mostrando fallback.");
                        showShareFallbackModal(shareData.url, shareData.title, shareData.text);
                    }
                });
            } else {
                console.error("DEBUG_ERROR: Botão de partilha NÃO encontrado!");
            }
        } catch (e) {
            console.error("DEBUG_ERROR: Erro na configuração da lógica de partilha:", e);
        }

        function showShareFallbackModal(url, title, text) {
            console.log("DEBUG: showShareFallbackModal chamada com URL:", url);
            const modal = document.getElementById('share-fallback-modal');
            const textContentElement = document.getElementById('fallback-text-content');
            const urlInput = document.getElementById('fallback-url-input');
            const copyButton = document.getElementById('copy-fallback-url-button');
            const whatsappLink = document.getElementById('whatsapp-fallback-link');
            const closeModalButton = document.getElementById('close-fallback-modal-button');

            if (!modal || !textContentElement || !urlInput || !copyButton || !whatsappLink || !closeModalButton) {
                console.error("DEBUG_ERROR: Um ou mais elementos do modal de fallback não foram encontrados!");
                return;
            }

            const displayText = `${title}\n${text.replace(/\\n/g, '\n')}`; // JS replace \n string to actual newline
            textContentElement.innerText = displayText;
            urlInput.value = url;

            copyButton.onclick = async () => {
                console.log("DEBUG: Botão Copiar URL (fallback) clicado.");
                try {
                    await navigator.clipboard.writeText(url);
                    alert('URL copiado para a área de transferência!');
                } catch (err) {
                    try {
                        urlInput.select();
                        document.execCommand('copy');
                        alert('URL copiado (método antigo)!');
                    } catch (copyErr) {
                        alert('Erro ao copiar. Por favor, copie manualmente.');
                        console.error("DEBUG_ERROR: Erro ao copiar URL no fallback:", copyErr);
                    }
                }
            };

            const whatsappMessage = encodeURIComponent(`${title}\n${text.replace(/\\n/g, '\n')}\n${url}`);
            whatsappLink.href = `https://wa.me/?text=${whatsappMessage}`;
            
            modal.style.display = 'flex';
            console.log("DEBUG: Modal de fallback exibido.");

            closeModalButton.onclick = () => {
                modal.style.display = 'none';
                console.log("DEBUG: Modal de fallback fechado pelo botão.");
            };
            modal.onclick = (event) => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                    console.log("DEBUG: Modal de fallback fechado pelo clique fora.");
                }
            };
            document.querySelector('.share-fallback-content').onclick = (event) => {
                event.stopPropagation();
            };
        }
        // --- Fim da Lógica de Partilha ---

        // --- Lógica addToContacts e cardLinksData ---
        try {
            console.log("DEBUG: Configurando lógica addToContacts...");
            // Atenção aqui: Jinja renderiza no servidor. Isto será um array/null JS constante.
            const cardLinksData = {{ dados.card_links | tojson | safe }};
            console.log("DEBUG: cardLinksData:", cardLinksData);

            if (typeof addToContacts !== 'function') { // Evitar redefinir se já incluído em outro lugar
                window.addToContacts = function() { // Tornar global ou certificar que está no escopo do onclick
                    console.log("DEBUG: addToContacts chamada.");
                    try {
                        const sanitizeVCardString = (str) => {
                            if (typeof str !== 'string') return '';
                            let cleanedStr = str.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, '');
                            cleanedStr = cleanedStr.replace(/\\/g, '\\\\');
                            cleanedStr = cleanedStr.replace(/,/g, '\\,');
                            cleanedStr = cleanedStr.replace(/;/g, '\\;');
                            cleanedStr = cleanedStr.replace(/\n/g, '\\n');
                            return cleanedStr;
                        };
                        const sanitizeForFilename = (str) => {
                            if (typeof str !== 'string') return 'contato';
                            return str.replace(/[^a-z0-9_\-]/ig, '_');
                        };

                        // Usar `dados` diretamente do Jinja aqui, garantindo que sejam strings JS válidas
                        const cardNome = sanitizeVCardString({{ (dados.card_nome if dados.card_nome else dados.nome if dados.nome else '') | tojson | safe }});
                        const cardTitulo = sanitizeVCardString({{ (dados.card_titulo if dados.card_titulo else '') | tojson | safe }});
                        const cardRegistro = sanitizeVCardString({{ (dados.card_registro_profissional if dados.card_registro_profissional else '') | tojson | safe }});
                        const email = sanitizeVCardString({{ (dados.email if dados.email else '') | tojson | safe }});

                        let vCardData = `BEGIN:VCARD\nVERSION:3.0\nN:${cardNome};;;;\nFN:${cardNome}`;
                        if (cardTitulo) vCardData += `\nTITLE:${cardTitulo}`;
                        if (cardRegistro) vCardData += `\nORG:${cardRegistro}`;
                        if (email) vCardData += `\nEMAIL;TYPE=INTERNET,PREF:${email}`;

                        if (Array.isArray(cardLinksData)) {
                            cardLinksData.forEach(link => {
                                if (typeof link !== 'object' || link === null) {
                                    console.warn("DEBUG_WARN: Item inválido em cardLinksData:", link);
                                    return; // Pular este link
                                }
                                const icon_type = link.icon ? String(link.icon).toLowerCase() : "";
                                const link_url_original = link.url || "";
                                const link_at_text_original = link.at_text || "";
                                const link_url_sanitized = sanitizeVCardString(link_url_original);
                                const link_at_text_sanitized = sanitizeVCardString(link_at_text_original);
                                let iconNameForNote = link.icon ? String(link.icon).replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : "Contato";

                                if (icon_type.includes('whatsapp') || icon_type.includes('phone') || String(link_url_original).startsWith('tel:')) {
                                    let phone_number = String(link_url_original).replace('tel:', '').replace('https://wa.me/', '');
                                    if (phone_number) { vCardData += `\nTEL;TYPE=CELL:${sanitizeVCardString(phone_number.split('?')[0])}`; }
                                } else if (icon_type.includes('mail') || icon_type.includes('email') || String(link_url_original).startsWith('mailto:')) {
                                    let email_address = String(link_url_original).replace('mailto:', '');
                                    if (email_address) { vCardData += `\nEMAIL;TYPE=INTERNET:${sanitizeVCardString(email_address.split('?')[0])}`; }
                                } else if (link_url_original) {
                                    if (icon_type.includes('linkedin')) { vCardData += `\nX-SOCIALPROFILE;TYPE=linkedin:${link_url_sanitized}`; }
                                    else if (icon_type.includes('twitter') || icon_type.includes('x-com')) { vCardData += `\nX-SOCIALPROFILE;TYPE=twitter:${link_url_sanitized}`; }
                                    else if (icon_type.includes('instagram')) { vCardData += `\nX-SOCIALPROFILE;TYPE=instagram:${link_url_sanitized}`; }
                                    else if (icon_type.includes('facebook')) { vCardData += `\nX-SOCIALPROFILE;TYPE=facebook:${link_url_sanitized}`; }
                                    else { vCardData += `\nURL;TYPE=${sanitizeVCardString(iconNameForNote.replace(/ /g, ''))}:${link_url_sanitized}`; }
                                }
                                if (link_at_text_original) {
                                    if (icon_type.includes('linkedin') && !link_url_original) { iconNameForNote = 'LinkedIn Handle'; }
                                    else if ((icon_type.includes('twitter') || icon_type.includes('x-com')) && !link_url_original) {
                                        iconNameForNote = 'Twitter/X Handle'; if (!String(link_at_text_original).startsWith('@')) { link_at_text_sanitized = sanitizeVCardString('@' + link_at_text_original); }
                                    } else if (icon_type.includes('instagram') && !link_url_original) {
                                        iconNameForNote = 'Instagram Handle'; if (!String(link_at_text_original).startsWith('@')) { link_at_text_sanitized = sanitizeVCardString('@' + link_at_text_original); }
                                    }
                                    vCardData += `\nNOTE:${iconNameForNote}: ${link_at_text_sanitized}`;
                                }
                            });
                        } else {
                            console.warn("DEBUG_WARN: cardLinksData não é um array ou é nulo/vazio.");
                        }

                        vCardData += `\nEND:VCARD`;
                        console.log("DEBUG: vCardData gerado:", vCardData);

                        const blob = new Blob([vCardData], { type: 'text/vcard;charset=utf-8' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        const profileNameForFile = sanitizeForFilename({{ (dados.profile if dados.profile else 'contato') | tojson | safe }});
                        a.download = `contato_${profileNameForFile}.vcf`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        console.log("DEBUG: Download do vCard iniciado.");
                    } catch(e) {
                        console.error("DEBUG_ERROR: Erro dentro da função addToContacts:", e);
                        alert("Ocorreu um erro ao gerar o contato vCard.");
                    }
                };
            }
             // Garantir que addToContacts está no escopo global se o onclick for diretamente no HTML
            if (typeof window.addToContacts === 'undefined' && typeof addToContacts === 'function') {
                window.addToContacts = addToContacts;
            }

        } catch (e) {
            console.error("DEBUG_ERROR: Erro na configuração da lógica addToContacts:", e);
        }
        console.log("DEBUG: Fim do script (DOMContentLoaded).");
    });
    console.log("DEBUG: Script principal finalizado (fora do DOMContentLoaded).");
</script>
</body>
</html>