<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <title>{{ og_title | default(dados.nome if dados.nome else 'Perfil Pessoal', true) | e }}</title>
    <meta property="og:title" content="{{ og_title | default(dados.nome if dados.nome else 'Perfil Pessoal', true) | e }}">
    <meta property="og:description" content="{{ og_description | default((dados.bio | striptags | truncate(150)) if dados.bio else 'Confira esta página!', true) | e }}">
    <meta property="og:url" content="{{ request.url_root.rstrip('/') }}{{ url_for('user_page', profile=dados.profile) }}">

    {# A imagem OG agora usará a foto de perfil (passada como og_image) ou uma imagem padrão do site #}
    {% if og_image %}
        <meta property="og:image" content="{{ (og_image if og_image.startswith('http') else url_for('static', filename=og_image, _external=True)) | e }}">
    {# Você pode adicionar um fallback para uma imagem OG padrão do seu site aqui, se og_image não for passada E dados.foto não existir #}
    {# Ex: {% elif url_for('static', filename='default_og_image.png', _external=True) %} #}
    {# <meta property="og:image" content="{{ url_for('static', filename='default_og_image.png', _external=True) | e }}"> #}
    {% endif %}
    {# Se a foto de perfil tiver dimensões conhecidas, você pode adicioná-las aqui #}
    {# <meta property="og:image:width" content="LARGURA_DA_FOTO_DE_PERFIL"> #}
    {# <meta property="og:image:height" content="ALTURA_DA_FOTO_DE_PERFIL"> #}
    <meta property="og:type" content="profile">

    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <style>
        /* Seu CSS existente para animação de setas e modal de compartilhamento */
        @keyframes subtle-bounce-right { 0%, 100% { transform: translateX(0); } 50% { transform: translateX(4px); } }
        @keyframes subtle-bounce-left { 0%, 100% { transform: translateX(0); } 50% { transform: translateX(-4px); } }
        .swiper-button-next.swiper-arrow-animated::after { animation: subtle-bounce-right 0.8s ease-in-out infinite; }
        .swiper-button-prev.swiper-arrow-animated::after { animation: subtle-bounce-left 0.8s ease-in-out infinite; }
        .swiper-button-disabled.swiper-arrow-animated::after { animation: none !important; }
        #share-button-container { position: fixed; top: 20px; right: 20px; z-index: 1005; background-color: rgba(255, 255, 255, 0.85); color: #333; width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); transition: background-color 0.3s ease, transform 0.2s ease; }
        #share-button-container:hover { background-color: rgba(240, 240, 240, 0.95); transform: scale(1.1); }
        #share-button-container i { font-size: 20px; }
        #share-fallback-modal { display: none !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 2000; justify-content: center; align-items: center; padding: 15px; box-sizing: border-box; }
        .share-fallback-content { background-color: #fff; color: #333; padding: 25px; border-radius: 10px; text-align: center; max-width: 350px; width: 100%; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); }
        .share-fallback-content h3 { margin-top: 0; margin-bottom: 15px; font-size: 1.3em; color: #4361ee; }
        .share-fallback-content p { margin-bottom: 15px; font-size: 0.9em; white-space: pre-wrap; color: #555; max-height: 100px; overflow-y: auto; border: 1px solid #eee; padding: 8px; border-radius: 5px; background-color: #f9f9f9; }
        .share-fallback-content input[type="text"] { width: calc(100% - 22px); padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px; font-size: 0.9em; box-sizing: border-box; }
        .share-fallback-content button, .share-fallback-content a.share-fallback-btn { display: inline-block; padding: 10px 18px; margin: 8px 5px; border-radius: 5px; text-decoration: none; font-size: 0.9em; font-weight: 500; cursor: pointer; transition: background-color 0.3s ease, transform 0.2s ease; border: none; }
        .share-fallback-btn-primary { background-color: #4361ee; color: white; }
        .share-fallback-btn-primary:hover { background-color: #3f37c9; transform: translateY(-1px); }
        .share-fallback-btn-whatsapp { background-color: #25D366; color: white; }
        .share-fallback-btn-whatsapp:hover { background-color: #1DAE52; transform: translateY(-1px); }
        .share-fallback-btn-secondary { background-color: #6c757d; color: white; }
        .share-fallback-btn-secondary:hover { background-color: #5a6268; }

        /* Botão de Download do Cartão REMOVIDO, então .moved-card-actions-container pode precisar de ajustes se o botão "Salvar Contato" ficar sozinho */
        .moved-card-actions-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px; 
            margin-top: 15px; 
            width: 100%;
        }
        .moved-card-actions-container .add-to-contacts-btn { /* Estilo para o botão Salvar Contato se ele for o único */
            width: auto; 
            min-width: 180px; 
            max-width: 90%;   
            box-sizing: border-box;
        }
        /* Se não houver mais botões abaixo do cartão, você pode remover .moved-card-actions-container completamente */


        .card-bottom-section {
            display: flex;
            justify-content: space-between; 
            align-items: flex-end; 
            width: 100%;
            margin-top: auto; 
            gap: 8px; 
            min-height: 40px; 
        }

        .card-links { 
            flex-grow: 1; 
            display: flex;
            flex-direction: column;
            gap: 2px !important;
            align-items: flex-start !important;
            overflow: hidden;
        }

        .card-address-area {
            flex-shrink: 0; 
            text-align: right;
            max-width: 45%; 
        }

        .card-address-text {
            font-size: clamp(10px, 2.5vw, 12px); 
            margin: 0;
            word-break: break-word; /* Substituído para overflow-wrap se WeasyPrint reclamar */
            overflow-wrap: break-word; /* Alternativa mais moderna */
            line-height: 1.3; 
            padding-bottom: 2px; 
        }
    </style>
</head>

{% if session.logado and session.profile == dados.profile %}
<div style="position: fixed; bottom: 20px; right: 20px; z-index: 1001;">
    <a href="{{ url_for('admin_panel', username=dados.profile) }}"
        style="background: #4361ee; color: white; padding: 10px 15px; border-radius: 8px; text-decoration: none; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
        <i class="fas fa-edit"></i> Editar Página
    </a>
</div>
{% endif %}

<div id="share-button-container" title="Compartilhar">
    <i class="fas fa-share-nodes"></i>
</div>

<div id="share-fallback-modal">
    <div class="share-fallback-content">
        <h3>Compartilhar</h3>
        <p id="fallback-text-content">Conteúdo da partilha aqui.</p>
        <input type="text" id="fallback-url-input" readonly title="URL para compartilhar">
        <button id="copy-fallback-url-button" class="share-fallback-btn-primary" title="Copiar URL">
            <i class="fas fa-copy"></i> Copiar URL
        </button>
        <a id="whatsapp-fallback-link" href="#" target="_blank" class="share-fallback-btn share-fallback-btn-whatsapp"
            title="Compartilhar no WhatsApp">
            <i class="fab fa-whatsapp"></i> WhatsApp
        </a>
        <button id="close-fallback-modal-button" class="share-fallback-btn-secondary">Fechar</button>
    </div>
</div>


<body {% if dados.background %}style="background-image: url('{{ (dados.background if dados.background.startswith('http') else url_for('static', filename=dados.background)) | e }}'); background-size: cover; background-position: center; background-attachment: fixed;" {% else %} style="background-color: #000;" {% endif %}>
    <div class="swiper-container">
        <div class="swiper-wrapper">
            {# Slide 0: Perfil #}
            <div class="swiper-slide user-page-slide">
                <div class="container">
                    {% if dados.foto %}
                    <img src="{{ (dados.foto if dados.foto.startswith('http') else url_for('static', filename=dados.foto)) | e }}"
                        alt="Foto de perfil" class="profile-pic">
                    {% endif %}

                    <h1 style="font-family: {{ dados.nome_font | style_safe | default(DEFAULT_FONT, true) }}; color: {{ dados.nome_color | default('#FFFFFF', true) }};">
                        {{ dados.nome if dados.nome else 'Usuário' }}
                    </h1>

                    {% if dados.bio %}
                    <p class="bio" style="font-family: {{ dados.bio_font | style_safe | default(DEFAULT_FONT, true) }}; color: {{ dados.bio_color | default('#CCCCCC', true) }};">
                        {{ dados.bio }}
                    </p>
                    {% endif %}

                    <div class="social-icons">
                        {% for link in dados.social_links %}
                        <a href="{{ link.url | e }}" target="_blank" title="{{ link.icon | replace('-', ' ') | title | e }}">
                            <img src="{{ url_for('static', filename='icons/' + link.icon + '.png') | e }}" class="icon"
                                alt="{{ link.icon | replace('-', ' ') | title | e }}">
                        </a>
                        {% endfor %}
                    </div>

                    {% if dados.custom_buttons %}
                    <div class="custom-buttons-container">
                        {% for button in dados.custom_buttons %}
                        <a href="{{ button.link | e }}"
                            class="link-button-custom {% if button.hasHoverEffect %}has-hover-effect{% endif %} {% if button.shadowType and button.shadowType != 'none' %}shadow-{{ button.shadowType }}{% endif %}"
                            style="background: {{ button.color | style_safe }}; border-radius: {{ button.radius }}px; color: {{ button.textColor | style_safe }}; font-weight: {{ 'bold' if button.bold else 'normal' }}; font-style: {{ 'italic' if button.italic else 'normal' }}; font-size: {{ button.fontSize }}px; {% if button.hasBorder %}border: {{ button.borderWidth }}px solid {{ button.borderColor | style_safe }};{% else %}border: none;{% endif %}"
                            target="_blank">
                            {{ button.text }}
                        </a>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <footer>
                        <p>Desenvolvido por CPages ✨</p>
                    </footer>
                </div>
            </div>

            {# Slide 1: Cartão de Visitas #}
            <div class="swiper-slide card-page-slide">
                <div class="card-container"
                    style="{% if dados.card_background_type == 'color' %}background-color: {{ dados.card_background_value | default('#4361ee', true) | style_safe }};{% elif dados.card_background_type == 'image' and dados.card_background_value %}background-image: url('{{ (dados.card_background_value if dados.card_background_value.startswith('http') else url_for('static', filename=dados.card_background_value)) | e }}'); background-size: cover; background-position: center;{% else %}background-color: #4361ee;{% endif %}">
                    <div class="card-content">
                        <div class="card-header-info">
                            <h2 style="font-family: {{ dados.card_nome_font | style_safe | default(DEFAULT_FONT, true) }}; color: {{ dados.card_nome_color | default(DEFAULT_TEXT_COLOR_CARD, true) }};">
                                {{ dados.card_nome if dados.card_nome else dados.nome }}
                            </h2>
                            {% if dados.card_titulo %}
                            <p class="card-title" style="font-family: {{ dados.card_titulo_font | style_safe | default(DEFAULT_FONT, true) }}; color: {{ dados.card_titulo_color | default(DEFAULT_TITLE_COLOR_CARD, true) }};">
                                {{ dados.card_titulo }}
                            </p>
                            {% endif %}
                            {% if dados.card_registro_profissional %}
                            <p class="card-registration" style="font-family: {{ dados.card_registro_font | style_safe | default(DEFAULT_FONT, true) }}; color: {{ dados.card_registro_color | default(DEFAULT_REG_COLOR_CARD, true) }};">
                                {{ dados.card_registro_profissional }}
                            </p>
                            {% endif %}
                        </div>

                        <div class="card-bottom-section">
                            <div class="card-links">
                                {% for link in dados.card_links %}
                                <a href="{{ (link.url if link.url else '#') | e }}" target="_blank" class="card-link-item"
                                    title="{{ (link.at_text if link.at_text else (link.icon | replace('-', ' ') | title)) | e }}">
                                    <img src="{{ url_for('static', filename='icons/' + link.icon + '.png') | e }}" class="card-icon"
                                        alt="{{ (link.icon | replace('-', ' ') | title) | e }}">
                                    {% if link.at_text %}
                                    <span class="card-link-text"
                                        style="color: {{ link.color | default(dados.card_link_text_color, true) | default(DEFAULT_TEXT_COLOR_CARD, true) | style_safe }};
                                               font-family: {{ link.font | style_safe | default(DEFAULT_FONT, true) }};">
                                        {{ link.at_text }}
                                    </span>
                                    {% endif %}
                                </a>
                                {% endfor %}
                            </div>
                            
                            {% if dados.card_endereco %}
                            <div class="card-address-area">
                                <p class="card-address-text" 
                                   style="font-family: {{ dados.card_endereco_font | style_safe | default(DEFAULT_FONT, true) }}; color: {{ dados.card_endereco_color | default(DEFAULT_CARD_ENDERECO_COLOR, true) }};">
                                    {{ dados.card_endereco }}
                                </p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                {# Container para os botões movidos ABAIXO do cartão #}
                {# O botão de download foi REMOVIDO #}
                <div class="moved-card-actions-container">
                    <button class="add-to-contacts-btn" onclick="addToContacts()">
                        <i class="fas fa-address-book"></i> Salvar Contato
                    </button>
                    {# O botão de download foi removido daqui #}
                </div>

            </div>
        </div>

        <div class="swiper-pagination"></div>
        <div class="swiper-button-prev"></div>
        <div class="swiper-button-next"></div>
    </div>

<script>
    // O JavaScript permanece o mesmo da versão anterior, pois a lógica do Swiper,
    // compartilhamento, e "Salvar Contato" (VCF) não foi alterada.
    // Apenas o botão de download do cartão foi removido do HTML.

    console.log("DEBUG: Script principal iniciado.");
    document.body.style.opacity = 0; 

    window.addEventListener('DOMContentLoaded', () => {
        console.log("DEBUG: DOMContentLoaded acionado.");
        setTimeout(() => {
            document.body.style.opacity = 1; 
            console.log("DEBUG: Opacidade do body definida para 1.");
        }, 100); 

        const userPageSlide = document.querySelector('.user-page-slide');
        if (userPageSlide) {
            userPageSlide.addEventListener('wheel', function (event) {
                const el = this; const scrollHeight = el.scrollHeight; const clientHeight = el.clientHeight;
                const scrollTop = el.scrollTop; const deltaY = event.deltaY;
                if (scrollHeight <= clientHeight) { return; }
                const atTop = scrollTop <= 0; const atBottom = scrollTop >= (scrollHeight - clientHeight - 1);
                if ((deltaY < 0 && atTop) || (deltaY > 0 && atBottom)) { return; }
                else { event.stopPropagation(); el.scrollTop += deltaY; }
            }, { passive: true });
        } else {
            console.error("DEBUG_ERROR: Elemento .user-page-slide NÃO encontrado!");
        }

        let swiperInstance = null; 
        try {
            function applyArrowAnimation(currentSwiper) {
                if (!currentSwiper || !currentSwiper.navigation) { console.warn("DEBUG_WARN: Instância Swiper ou navegação indefinida."); return; }
                const prevEl = currentSwiper.navigation.prevEl; const nextEl = currentSwiper.navigation.nextEl;
                if (!prevEl || !nextEl) { console.warn("DEBUG_WARN: Elementos de seta não encontrados."); return; }
                prevEl.classList.remove('swiper-arrow-animated'); nextEl.classList.remove('swiper-arrow-animated');
                if (!currentSwiper.isEnd) { nextEl.classList.add('swiper-arrow-animated'); }
                if (!currentSwiper.isBeginning) { prevEl.classList.add('swiper-arrow-animated'); }
            }

            swiperInstance = new Swiper('.swiper-container', {
                effect: 'creative',
                creativeEffect: { prev: { shadow: false, translate: ['-120%', 0, -500], }, next: { shadow: false, translate: ['120%', 0, -500], }, },
                grabCursor: true,
                pagination: { el: '.swiper-pagination', clickable: true, },
                navigation: { nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev', },
                loop: false, simulateTouch: true,
                mousewheel: { enabled: true, releaseOnEdges: true, },
                observer: true, observeParents: true,
                on: { 
                    init: function () { 
                        applyArrowAnimation(this); 
                        const currentUrlParams = new URLSearchParams(window.location.search);
                        if (currentUrlParams.has('view') && currentUrlParams.get('view') === 'card') {
                            this.slideTo(1, 0, false); 
                            console.log("DEBUG: Swiper direcionado para o slide do cartão (índice 1) na inicialização.");
                        }
                    }, 
                    slideChangeTransitionEnd: function () { applyArrowAnimation(this); } 
                }
            });
            console.log("DEBUG: Swiper inicializado. Instância:", swiperInstance);
        } catch (e) {
            console.error("DEBUG_ERROR: ERRO CRÍTICO AO INICIALIZAR O SWIPER:", e);
        }

        try {
            const shareButton = document.getElementById('share-button-container');
            if (shareButton) {
                shareButton.addEventListener('click', async () => {
                    if (!swiperInstance) {
                        alert("Erro: Funcionalidade de swipe não está pronta."); return;
                    }
                    const currentSlideIndex = swiperInstance.activeIndex;
                    const pageUrlForSharing = {{ (request.url_root.rstrip('/') + url_for('user_page', profile=dados.profile)) | tojson | safe }};
                    let shareData = { title: '', text: '', url: pageUrlForSharing };

                    if (currentSlideIndex === 0) { 
                        shareData.title = {{ og_title | default(dados.nome if dados.nome else 'Perfil', true) | tojson | safe }};
                        shareData.text = {{ og_description | default(dados.bio if dados.bio else 'Confira!', true) | tojson | safe }};
                    } else { 
                        const cardNameForShare = {{ (dados.card_nome if dados.card_nome else dados.nome if dados.nome else 'Usuário') | tojson | safe }};
                        shareData.title = `Cartão de Visita: ${cardNameForShare}`;
                        let cardTextParts = [];
                        const cardTitleText = {{ (dados.card_titulo if dados.card_titulo else '') | tojson | safe }};
                        const cardRegText = {{ (dados.card_registro_profissional if dados.card_registro_profissional else '') | tojson | safe }};
                        const cardEnderecoText = {{ (dados.card_endereco if dados.card_endereco else '') | tojson | safe }};
                        if (cardTitleText) cardTextParts.push(cardTitleText);
                        if (cardRegText) cardTextParts.push(cardRegText);
                        if (cardEnderecoText) cardTextParts.push(cardEnderecoText);
                        let cardDynamicDescriptionForShare = cardTextParts.join(" | ");
                        if (!cardDynamicDescriptionForShare) {
                            cardDynamicDescriptionForShare = `Acesse o cartão de visita de ${cardNameForShare}.`;
                        }
                        shareData.text = cardDynamicDescriptionForShare;
                        // A URL de partilha não precisa mais de ?view=card para a imagem OG do cartão.
                    }
                    console.log("DEBUG: Dados para partilha (navigator.share ou fallback):", JSON.stringify(shareData));

                    if (navigator.share) {
                        try {
                            await navigator.share(shareData);
                        } catch (err) {
                            if (err.name !== 'AbortError') { 
                                showShareFallbackModal(shareData.url, shareData.title, shareData.text);
                            }
                        }
                    } else {
                        showShareFallbackModal(shareData.url, shareData.title, shareData.text);
                    }
                });
            }
        } catch (e) {
            console.error("DEBUG_ERROR: Erro na configuração da lógica de partilha:", e);
        }
        
        function showShareFallbackModal(url, title, text) {
            const modal = document.getElementById('share-fallback-modal');
            const textContentElement = document.getElementById('fallback-text-content');
            const urlInput = document.getElementById('fallback-url-input');
            const copyButton = document.getElementById('copy-fallback-url-button');
            const whatsappLink = document.getElementById('whatsapp-fallback-link');
            const closeModalButton = document.getElementById('close-fallback-modal-button');
            if (!modal || !textContentElement || !urlInput || !copyButton || !whatsappLink || !closeModalButton) { return; }
            const displayText = `${title}\n${text.replace(/\\n/g, '\n')}`; 
            textContentElement.innerText = displayText;
            urlInput.value = url; 
            copyButton.onclick = async () => { try { await navigator.clipboard.writeText(url); alert('URL copiado!'); } catch (err) { try { urlInput.select(); document.execCommand('copy'); alert('URL copiado (método antigo)!'); } catch (copyErr) { alert('Erro ao copiar.'); }}};
            const whatsappMessage = encodeURIComponent(`${title}\n${text.replace(/\\n/g, '\n')}\n${url}`);
            whatsappLink.href = `https://wa.me/?text=${whatsappMessage}`;
            modal.style.display = 'flex';
            closeModalButton.onclick = () => { modal.style.display = 'none'; };
            modal.onclick = (event) => { if (event.target === modal) { modal.style.display = 'none'; } };
            document.querySelector('.share-fallback-content').onclick = (event) => { event.stopPropagation(); };
        }
        
        try {
            const cardLinksData = {{ dados.card_links | tojson | safe }};
            const cardEnderecoVCF = {{ (dados.card_endereco if dados.card_endereco else '') | tojson | safe }};
            if (typeof addToContacts !== 'function') { 
                window.addToContacts = function() { 
                    try {
                        const sanitizeVCardString = (str) => { if (typeof str !== 'string') return ''; let cleanedStr = str.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, ''); cleanedStr = cleanedStr.replace(/\\/g, '\\\\').replace(/,/g, '\\,').replace(/;/g, '\\;').replace(/\n/g, '\\n'); return cleanedStr; };
                        const sanitizeForFilename = (str) => { if (typeof str !== 'string') return 'contato'; return str.replace(/[^a-z0-9_\-]/ig, '_'); };
                        const cardNome = sanitizeVCardString({{ (dados.card_nome if dados.card_nome else dados.nome if dados.nome else '') | tojson | safe }});
                        const cardTitulo = sanitizeVCardString({{ (dados.card_titulo if dados.card_titulo else '') | tojson | safe }});
                        const cardRegistro = sanitizeVCardString({{ (dados.card_registro_profissional if dados.card_registro_profissional else '') | tojson | safe }});
                        const email = sanitizeVCardString({{ (dados.email if dados.email else '') | tojson | safe }}); 
                        let vCardData = `BEGIN:VCARD\nVERSION:3.0\nN:${cardNome};;;;\nFN:${cardNome}`;
                        if (cardTitulo) vCardData += `\nTITLE:${cardTitulo}`;
                        if (cardRegistro) vCardData += `\nORG:${cardRegistro}`; 
                        if (email) vCardData += `\nEMAIL;TYPE=INTERNET,PREF:${email}`;
                        if (cardEnderecoVCF) vCardData += `\nADR;TYPE=WORK,PREF:;;${sanitizeVCardString(cardEnderecoVCF)};;;;`;

                        if (Array.isArray(cardLinksData)) {
                            cardLinksData.forEach(link => {  
                                if (typeof link !== 'object' || link === null) { return; }
                                const icon_type = link.icon ? String(link.icon).toLowerCase() : "";
                                const link_url_original = link.url || ""; const link_at_text_original = link.at_text || "";
                                const link_url_sanitized = sanitizeVCardString(link_url_original); const link_at_text_sanitized = sanitizeVCardString(link_at_text_original);
                                let iconNameForNote = link.icon ? String(link.icon).replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : "Contato";
                                if (icon_type.includes('whatsapp') || icon_type.includes('phone') || String(link_url_original).startsWith('tel:')) {
                                    let phone_number = String(link_url_original).replace('tel:', '').replace('https://wa.me/', '');
                                    if (phone_number) { vCardData += `\nTEL;TYPE=CELL:${sanitizeVCardString(phone_number.split('?')[0])}`; }
                                } else if (icon_type.includes('mail') || icon_type.includes('email') || String(link_url_original).startsWith('mailto:')) {
                                    let email_address = String(link_url_original).replace('mailto:', '');
                                    if (email_address && email_address !== email) { vCardData += `\nEMAIL;TYPE=INTERNET:${sanitizeVCardString(email_address.split('?')[0])}`; } 
                                } else if (link_url_original) {
                                    if (icon_type.includes('linkedin')) { vCardData += `\nX-SOCIALPROFILE;TYPE=linkedin:${link_url_sanitized}`; }
                                    else if (icon_type.includes('twitter') || icon_type.includes('x-com')) { vCardData += `\nX-SOCIALPROFILE;TYPE=twitter:${link_url_sanitized}`; }
                                    else { vCardData += `\nURL;TYPE=${sanitizeVCardString(iconNameForNote.replace(/ /g,''))}:${link_url_sanitized}`; }
                                }
                                if (link_at_text_original) { vCardData += `\nNOTE:${iconNameForNote}: ${link_at_text_sanitized}`; }
                            });
                        }
                        vCardData += `\nEND:VCARD`;
                        const blob = new Blob([vCardData], { type: 'text/vcard;charset=utf-8' });
                        const url = URL.createObjectURL(blob); const a = document.createElement('a');
                        a.href = url; const profileNameForFile = sanitizeForFilename({{ (dados.profile if dados.profile else 'contato') | tojson | safe }});
                        a.download = `contato_${profileNameForFile}.vcf`; document.body.appendChild(a);
                        a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
                    } catch(e) { console.error("DEBUG_ERROR: Erro em addToContacts:", e); alert("Erro ao gerar vCard."); }
                };
            }
        } catch (e) {
            console.error("DEBUG_ERROR: Erro na configuração da lógica addToContacts:", e);
        }
        console.log("DEBUG: Fim do script (DOMContentLoaded).");
    });
    console.log("DEBUG: Script principal finalizado (fora do DOMContentLoaded).");
</script>
</body>
</html>