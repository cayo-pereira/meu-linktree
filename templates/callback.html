<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processando Login - CPages</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='admin.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='dark-mode.css') }}">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color-light); 
            color: var(--text-color-light); 
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            padding: 20px;
            text-align: center;
        }
        .loading-container {
            background: var(--card-bg-light); 
            border-radius: var(--border-radius); 
            border: 1px solid var(--border-color-light); 
            padding: 40px;
            max-width: 450px;
            width: 100%;
            box-shadow: var(--shadow-light); 
            transition: all 0.3s ease; 
        }
        .logo { font-size: 1.8rem; font-weight: 600; color: var(--text-color-light); margin-bottom: 10px; }
        .logo span { color: var(--primary-color); }
        .loading-icon { font-size: 2.5rem; color: var(--primary-color); margin: 20px 0; animation: spin 1.5s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        h1 { color: var(--text-color-light); margin-bottom: 15px; font-weight: 500; font-size: 1.5rem; }
        p { color: var(--text-color-light); margin-bottom: 25px; line-height: 1.6; }
        .progress-container { width: 100%; height: 6px; background-color: var(--input-bg-light); border-radius: 3px; margin: 25px 0; overflow: hidden; }
        .progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); animation: progress 2.5s ease-in-out infinite; border-radius: 3px; }
        @keyframes progress { 0% { width: 0%; margin-left: 0%; } 50% { width: 100%; margin-left: 0%; } 100% { width: 0%; margin-left: 100%; } }
        .btn { display: inline-block; margin-top: 20px; padding: 10px 20px; background-color: var(--primary-color); color: white; text-decoration: none; border-radius: var(--border-radius); font-weight: 500; transition: all 0.3s ease; }
        .btn:hover { background-color: var(--secondary-color); transform: translateY(-2px); }
        .debug-info { font-size: 0.8rem; color: var(--text-color-light); margin-top: 30px; }
        #debug-log { margin-top: 15px; font-size: 0.7rem; text-align: left; max-height: 100px; overflow-y: auto; background: #eee; padding: 5px; border-radius: 3px; color: #333;}
    </style>
</head>
<body>
    <div class="loading-container">
        <div class="logo">C<span>Pages</span></div>
        <div class="loading-icon">
            <i class="fas fa-circle-notch"></i>
        </div>
        <h1>Quase lá!</h1>
        <p>Estamos preparando seu painel administrativo</p>
        <div class="progress-container">
            <div class="progress-bar"></div>
        </div>
        <a href="{{ url_for('index') }}" class="btn">
            <i class="fas fa-home"></i> Voltar ao início
        </a>
        <div class="debug-info">
            Se o redirecionamento não funcionar automaticamente, clique no botão acima.
            <div id="debug-log" style="background-color: var(--input-bg-light); color: var(--text-color-light); border: 1px solid var(--border-color-light);"></div>
        </div>
    </div>

    <script>
        const debugLogEl = document.getElementById('debug-log');
        function logToPage(message) {
            if(debugLogEl) {
                const p = document.createElement('p');
                p.textContent = message;
                p.style.margin = '2px 0';
                p.style.borderBottom = '1px solid var(--border-color-light)';
                p.style.paddingBottom = '2px';
                debugLogEl.appendChild(p);
            }
            console.log(message); // Log to console as well
        }

        function getHashParams() {
            const hashParams = {};
            const r = /([^&;=]+)=?([^&;]*)/g; 
            const q = window.location.hash.substring(1); 
            let e;
            while (e = r.exec(q)) {
                hashParams[e[1]] = decodeURIComponent(e[2]);
            }
            return hashParams;
        }

        function getQueryParams() {
            const queryParams = {};
            const r = /[?&]+([^=&]+)=([^&]*)/g;
            const q = window.location.search;
            let e;
            while (e = r.exec(q)) {
                queryParams[decodeURIComponent(e[1])] = decodeURIComponent(e[2]);
            }
            return queryParams;
        }

        window.onload = function() {
            logToPage("Página callback.html carregada.");
            logToPage("URL Completa: " + window.location.href);
            logToPage("Hash da URL: " + window.location.hash);
            logToPage("Query String: " + window.location.search);

            const hashData = getHashParams();
            const queryData = getQueryParams();

            const accessToken = hashData.access_token;
            const refreshToken = hashData.refresh_token;
            const authCode = queryData.code; // Get 'code' from query string
            const errorFromHash = hashData.error;
            const errorDescriptionFromHash = hashData.error_description;
            const errorFromQuery = queryData.error;
            const errorDescriptionFromQuery = queryData.error_description;

            logToPage("Dados do Hash: " + JSON.stringify(hashData));
            logToPage("Dados da Query String: " + JSON.stringify(queryData));

            if (errorFromHash) {
                logToPage("Erro no hash: " + errorFromHash + (errorDescriptionFromHash ? " - " + errorDescriptionFromHash : ""));
                window.location.href = "{{ url_for('index') }}?error=" + encodeURIComponent(errorFromHash) + (errorDescriptionFromHash ? "&error_description=" + encodeURIComponent(errorDescriptionFromHash) : "");
                return;
            }
            if (errorFromQuery) {
                logToPage("Erro na query string: " + errorFromQuery + (errorDescriptionFromQuery ? " - " + errorDescriptionFromQuery : ""));
                window.location.href = "{{ url_for('index') }}?error=" + encodeURIComponent(errorFromQuery) + (errorDescriptionFromQuery ? "&error_description=" + encodeURIComponent(errorDescriptionFromQuery) : "");
                return;
            }

            let payload = {};
            let authMethod = "";

            if (accessToken) {
                authMethod = "tokens";
                payload = {
                    access_token: accessToken,
                    refresh_token: refreshToken 
                };
                logToPage("Access Token encontrado no hash. Usando método de tokens.");
            } else if (authCode) {
                authMethod = "code";
                payload = {
                    auth_code: authCode
                };
                logToPage("Código de autorização ('code') encontrado na query string. Usando método de código.");
            } else {
                logToPage("Nenhum token no hash nem código na query string encontrados.");
                window.location.href = "{{ url_for('index') }}?error=no_token_or_code";
                return;
            }

            fetch("{{ url_for('callback') }}", { 
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
            })
            .then(response => {
                logToPage(`Resposta do fetch (/callback) com método '${authMethod}' - Status: ` + response.status);
                if (!response.ok) {
                    return response.json().then(errData => {
                        logToPage("Fetch NÃO OK, JSON: " + JSON.stringify(errData));
                        throw new Error(errData.error || `Erro do servidor: ${response.status}`);
                    }).catch((jsonError) => {
                        logToPage("Fetch NÃO OK, não JSON ou erro ao parsear: " + jsonError.message + " Status Text: " + response.statusText);
                        throw new Error(`Erro do servidor: ${response.status} ${response.statusText}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                logToPage("Dados do backend (/callback): " + JSON.stringify(data));
                if (data.redirect) {
                    logToPage("Redirecionando para: " + data.redirect);
                    window.location.href = data.redirect;
                } else if (data.error) { 
                    logToPage("Erro do backend: " + data.error);
                    window.location.href = "{{ url_for('index') }}?error=" + encodeURIComponent(data.error);
                } else {
                    logToPage("Resposta inesperada do servidor (sem redirect ou error).");
                    window.location.href = "{{ url_for('index') }}?error=unexpected_backend_response";
                }
            })
            .catch(error => {
                logToPage("Erro no fetch ou processamento: " + error.message);
                window.location.href = "{{ url_for('index') }}?error=callback_processing_error&details=" + encodeURIComponent(error.message);
            });
        };
    </script>
    <script src="{{ url_for('static', filename='js/dark-mode.js') }}"></script>
</body>
</html>